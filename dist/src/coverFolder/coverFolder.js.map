{
  "version": 3,
  "sources": [
    "../../../src/coverFolder/coverFolder.js"
  ],
  "names": [
    "mergeCoverage",
    "coverages",
    "mergedCoverageMap",
    "reduce",
    "previous",
    "coverage",
    "merge",
    "toJSON",
    "metaPredicate",
    "cover",
    "test",
    "testProject",
    "server",
    "createClient",
    "compileURL",
    "root",
    "process",
    "cwd",
    "beforeAll",
    "beforeEach",
    "afterEach",
    "afterAll",
    "rootLocation",
    "path",
    "resolve",
    "getRequiredFileReport",
    "then",
    "forEachFileMatching",
    "relativeName",
    "meta",
    "Promise",
    "all",
    "client",
    "fileReport",
    "testFiles",
    "filter",
    "file",
    "map",
    "type",
    "sourceFiles",
    "files",
    "getFileByPath",
    "find",
    "testFile",
    "execute",
    "collectCoverage",
    "executeTest",
    "autoClose",
    "promise",
    "output",
    "Object",
    "keys",
    "forEach",
    "sourceFile",
    "untestedSourceFiles",
    "getEmptyCoverageFor",
    "compileFile",
    "outputAssets",
    "coverageAsset",
    "asset",
    "name",
    "JSON",
    "parse",
    "content",
    "s",
    "key",
    "missingCoverage",
    "createCoverageFromTestReport"
  ],
  "mappings": "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",
  "sourcesContent": [
    "import { openChromiumClient } from \"../openChromiumClient/openChromiumClient.js\"\nimport path from \"path\"\nimport { createCoverageMap } from \"istanbul-lib-coverage\"\nimport { createRoot } from \"@dmail/project-structure\"\n\nconst mergeCoverage = (...coverages) => {\n  // https://github.com/istanbuljs/istanbuljs/blob/5405550c3868712b14fd8bfe0cbd6f2e7ac42279/packages/istanbul-lib-coverage/lib/coverage-map.js#L43\n  const mergedCoverageMap = coverages.reduce((previous, coverage) => {\n    return previous.merge(coverage)\n  }, createCoverageMap({}))\n\n  return mergedCoverageMap.toJSON()\n}\n\nconst metaPredicate = ({ cover, test }) => cover || test\n\nexport const testProject = ({\n  server,\n  createClient = () => openChromiumClient({ compileURL: server.compileURL }),\n  root = process.cwd(),\n  beforeAll = () => {},\n  beforeEach = () => {},\n  afterEach = () => {},\n  afterAll = () => {},\n}) => {\n  const rootLocation = path.resolve(process.cwd(), root)\n\n  const getRequiredFileReport = createRoot({ root: rootLocation }).then(\n    ({ forEachFileMatching }) => {\n      return forEachFileMatching(metaPredicate, ({ relativeName, meta }) => {\n        return { relativeName, meta }\n      })\n    },\n  )\n\n  return Promise.all([createClient(), getRequiredFileReport()]).then(([client, fileReport]) => {\n    const testFiles = fileReport.filter((file) => file.meta.test).map((file) => {\n      return {\n        path: `${rootLocation}/${file.relativeName}`,\n        type: \"test\",\n      }\n    })\n    const sourceFiles = fileReport.filter((file) => file.meta.cover).map((file) => {\n      return {\n        path: `${rootLocation}/${file.relativeName}`,\n        type: \"source\",\n      }\n    })\n    const files = [...testFiles, ...sourceFiles]\n\n    const getFileByPath = (path) => files.find((file) => file.path === path)\n\n    beforeAll({ files })\n    return Promise.all(\n      testFiles.map((testFile) => {\n        beforeEach({ file: testFile })\n\n        return client\n          .execute({\n            file: testFile.path,\n            collectCoverage: true,\n            executeTest: true,\n            autoClose: true,\n          })\n          .then(({ promise }) => promise)\n          .then(({ output, coverage }) => {\n            // test = null means file.test.js do not set a global.__test\n            // which happens if file.test.js does not use @dmail/test or is empty for instance\n            // coverage = null means file.test.js do not set a global.__coverage__\n            // which happens if file.test.js was not instrumented.\n            // this is not supposed to happen so we should throw ?\n            testFile.output = output\n            Object.keys(coverage).forEach((path) => {\n              const sourceFile = getFileByPath(path)\n              sourceFile.coverage = sourceFile.coverage\n                ? mergeCoverage(sourceFile.coverage, coverage[path])\n                : coverage[path]\n            })\n\n            afterEach({ file: testFile })\n          })\n      }),\n    )\n      .then(() => {\n        afterAll({ files })\n\n        const untestedSourceFiles = sourceFiles.filter((sourceFile) => {\n          return !sourceFile.coverage\n        })\n\n        const getEmptyCoverageFor = (file) => {\n          // we must compileFile to get the coverage object\n          // without evaluating the file source because it would increment coverage\n          // and also execute code that is not supposed to be run\n          return server.compileFile(file).then(({ outputAssets }) => {\n            const coverageAsset = outputAssets.find((asset) => asset.name === \"coverage\")\n            const coverage = JSON.parse(coverageAsset.content)\n            // https://github.com/gotwarlost/istanbul/blob/bc84c315271a5dd4d39bcefc5925cfb61a3d174a/lib/command/common/run-with-cover.js#L229\n            Object.keys(coverage.s).forEach(function(key) {\n              coverage.s[key] = 0\n            })\n            return coverage\n          })\n        }\n\n        return Promise.all(\n          untestedSourceFiles.map((sourceFile) => {\n            return getEmptyCoverageFor(sourceFile).then((missingCoverage) => {\n              sourceFile.coverage = missingCoverage\n            })\n          }),\n        )\n      })\n      .then(() => {\n        return files\n      })\n  })\n}\n\nexport const createCoverageFromTestReport = (files) => {\n  const coverage = {}\n\n  files.forEach((file) => {\n    if (file.coverage) {\n      coverage[file.coverage.path] = file.coverage\n    }\n  })\n\n  return coverage\n}\n"
  ]
}