{"version":3,"sources":["../../../src/createCompile/instrumenter-babel.js"],"names":["createInstrumentPlugin","filename","useInlineSourceMaps","types","visitor","Program","enter","path","__dv__","inputSourceMap","opts","file","coverageVariable","exit","object","metadata","coverage","fileCoverage","instrumenter","context","inputRelativeLocation","inputSource","inputAst","outputSourceMapName","options","getSourceNameForSourceMap","getSourceLocationForSourceMap","remapOptions","remap","sourceMaps","sourceMapTarget","sourceFileName","babelOptions","babelrc","ast","babelConfig","plugins","push","result","outputSource","code","outputSourceMap","map","outputAst","outputAssets","JSON","stringify"],"mappings":"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","file":"instrumenter-babel.js","sourcesContent":["import { createConfig, createSyntaxOptions, mergeOptions } from \"@dmail/shared-config/dist/babel.js\"\nimport { transform, transformFromAst } from \"babel-core\"\nimport { programVisitor } from \"istanbul-lib-instrument\"\n\n// https://github.com/istanbuljs/babel-plugin-istanbul/blob/321740f7b25d803f881466ea819d870f7ed6a254/src/index.js\n\nconst createInstrumentPlugin = ({ filename, useInlineSourceMaps = false } = {}) => {\n  return ({ types }) => {\n    return {\n      visitor: {\n        Program: {\n          enter(path) {\n            this.__dv__ = null\n\n            let inputSourceMap\n            if (useInlineSourceMaps) {\n              inputSourceMap = this.opts.inputSourceMap || this.file.opts.inputSourceMap\n            } else {\n              inputSourceMap = this.opts.inputSourceMap\n            }\n\n            this.__dv__ = programVisitor(types, filename, {\n              coverageVariable: \"__coverage__\",\n              inputSourceMap,\n            })\n            this.__dv__.enter(path)\n          },\n\n          exit(path) {\n            if (!this.__dv__) {\n              return\n            }\n            const object = this.__dv__.exit(path)\n            // object got two properties: fileCoverage and sourceMappingURL\n            this.file.metadata.coverage = object.fileCoverage\n          },\n        },\n      },\n    }\n  }\n}\n\nexport const instrumenter = (context) => {\n  const {\n    inputRelativeLocation,\n    inputSource,\n    inputSourceMap,\n    inputAst,\n    outputSourceMapName,\n    options,\n    getSourceNameForSourceMap,\n    getSourceLocationForSourceMap,\n  } = context\n\n  const remapOptions = options.remap\n    ? {\n        sourceMaps: true,\n        sourceMapTarget: getSourceNameForSourceMap(context),\n        sourceFileName: getSourceLocationForSourceMap(context),\n      }\n    : {\n        sourceMaps: false,\n      }\n\n  const babelOptions = mergeOptions(\n    remapOptions,\n    // we need the syntax option to enable rest spread in case it's used\n    createSyntaxOptions(),\n    {\n      filename: inputRelativeLocation,\n      inputSourceMap,\n      babelrc: false, // trust only these options, do not read any babelrc config file\n      ast: true,\n    },\n  )\n  const babelConfig = createConfig(babelOptions)\n  babelConfig.plugins.push(\n    createInstrumentPlugin({ filename: inputRelativeLocation, useInlineSourceMaps: false }),\n  )\n\n  if (inputAst) {\n    const result = transformFromAst(inputAst, inputSource, babelConfig)\n    return {\n      outputSource: result.code,\n      outputSourceMap: result.map,\n      outputAst: result.ast,\n      outputAssets: {\n        [outputSourceMapName]: JSON.stringify(result.map, null, \"  \"),\n        \"coverage.json\": JSON.stringify(result.metadata.coverage, null, \"  \"),\n      },\n    }\n  }\n\n  const { code, ast, map, metadata } = transform(inputSource, babelConfig)\n  return {\n    outputSource: code,\n    outputSourceMap: map,\n    outputAst: ast,\n    outputAssets: {\n      [outputSourceMapName]: JSON.stringify(map, null, \"  \"),\n      \"coverage.json\": JSON.stringify(metadata.coverage, null, \"  \"),\n    },\n  }\n}\n"]}