{
  "version": 3,
  "sources": [
    "../../../src/createCompileService/createCompileService.js"
  ],
  "names": [
    "readBranchMain",
    "rootLocation",
    "cacheFolderRelativeLocation",
    "abstractFolderRelativeLocation",
    "filename",
    "inputLocation",
    "inputETagClient",
    "cache",
    "branch",
    "location",
    "then",
    "content",
    "inputETag",
    "Promise",
    "resolve",
    "status",
    "inputETagCached",
    "outputLocation",
    "errorHandler",
    "isFileNotFoundError",
    "error",
    "output",
    "moreData",
    "input",
    "readBranchAsset",
    "asset",
    "outputAssetLocation",
    "name",
    "actual",
    "expected",
    "eTag",
    "inputRelativeLocation",
    "readBranch",
    "all",
    "outputAssets",
    "map",
    "outputAsset",
    "mainData",
    "assetsData",
    "computedStatus",
    "invalidAsset",
    "find",
    "assetData",
    "getFileBranch",
    "groupId",
    "compile",
    "cacheDataLocation",
    "branches",
    "JSON",
    "parse",
    "Error",
    "JSON_FILE",
    "inputSource",
    "getSourceNameForSourceMap",
    "getSourceLocationForSourceMap",
    "options",
    "generate",
    "branchIsValid",
    "stringify",
    "outputMeta",
    "cachedBranch",
    "getFileReport",
    "compareBranch",
    "branchA",
    "branchB",
    "lastMatchDiff",
    "lastMatchMs",
    "matchCount",
    "updateBranch",
    "cacheAutoClean",
    "cacheTrackHit",
    "isCached",
    "isNew",
    "isUpdated",
    "promises",
    "mainLocation",
    "push",
    "assetLocation",
    "branchesToRemove",
    "slice",
    "index",
    "indexOf",
    "splice",
    "length",
    "forEach",
    "branchLocation",
    "console",
    "log",
    "updatedBranches",
    "branchToUpdate",
    "Number",
    "Date",
    "now",
    "lastModifiedMs",
    "createdMs",
    "sort",
    "updatedCache",
    "undefined",
    "getFileCompiled",
    "getBabelPlugins",
    "cacheEnabled",
    "fileLock",
    "chain",
    "outputRelativeLocation",
    "createCompileService",
    "fileService",
    "root",
    "getGroupIdForPlatform",
    "getPluginsFromGroupId",
    "service",
    "method",
    "url",
    "headers",
    "pathname",
    "endsWith",
    "script",
    "URL",
    "search",
    "reason",
    "reject",
    "platformName",
    "platformVersion",
    "has",
    "get",
    "Etag",
    "Buffer",
    "byteLength",
    "body",
    "compileFile",
    "relativeLocation"
  ],
  "mappings": "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",
  "sourcesContent": [
    "/* eslint-disable import/max-dependencies */\nimport cuid from \"cuid\"\nimport { URL } from \"url\"\nimport { createCompile } from \"../createCompile/createCompile.js\"\nimport { JSON_FILE } from \"./cache.js\"\nimport { createETag, isFileNotFoundError, removeFolderDeep } from \"./helpers.js\"\nimport { locateFile } from \"./locateFile.js\"\nimport { readFile } from \"./readFile.js\"\nimport { lockForRessource } from \"./ressourceRegistry.js\"\nimport { writeFileFromString } from \"@dmail/project-structure-compile-babel\"\nimport { createFileService } from \"../createFileService/createFileService.js\"\nimport { getPlatformAndVersionFromHeaders } from \"./getPlatformAndVersionFromHeaders.js\"\nimport {\n  getInputRelativeLocation,\n  getCacheDataLocation,\n  getOutputRelativeLocation,\n  getBranchLocation,\n  getOutputLocation,\n  getOutputAssetLocation,\n  getSourceAbstractLocation,\n  getSourceLocationForSourceMap,\n} from \"./locaters.js\"\nimport { buildGroup } from \"./buildGroup.js\"\n\nconst readBranchMain = ({\n  rootLocation,\n  cacheFolderRelativeLocation,\n  abstractFolderRelativeLocation,\n  filename,\n  inputLocation,\n  inputETagClient,\n  cache,\n  branch,\n}) => {\n  return readFile({ location: inputLocation }).then(({ content }) => {\n    const inputETag = createETag(content)\n\n    return Promise.resolve()\n      .then(() => {\n        // faudra pouvoir désactiver ce check lorsqu'on veut juste connaitre l'état du cache\n        if (inputETagClient) {\n          if (inputETag !== inputETagClient) {\n            return {\n              status: `eTag modified on ${inputLocation} since it was cached by client`,\n              inputETagClient,\n            }\n          }\n          return { status: \"valid\" }\n        }\n\n        const inputETagCached = cache.inputETag\n        if (inputETag !== inputETagCached) {\n          return {\n            status: `eTag modified on ${inputLocation} since it was cached on filesystem`,\n            inputETagCached,\n          }\n        }\n\n        const outputLocation = getOutputLocation({\n          rootLocation,\n          cacheFolderRelativeLocation,\n          abstractFolderRelativeLocation,\n          filename,\n          branch,\n        })\n        return readFile({\n          location: outputLocation,\n          errorHandler: isFileNotFoundError,\n        }).then(({ content, error }) => {\n          if (error) {\n            return {\n              status: `cache not found at ${outputLocation}`,\n            }\n          }\n          return { status: \"valid\", output: content }\n        })\n      })\n      .then((moreData) => {\n        return {\n          input: content,\n          inputETag,\n          ...moreData,\n        }\n      })\n  })\n}\n\nconst readBranchAsset = ({\n  rootLocation,\n  cacheFolderRelativeLocation,\n  abstractFolderRelativeLocation,\n  filename,\n  cache,\n  branch,\n  asset,\n}) => {\n  const outputAssetLocation = getOutputAssetLocation({\n    rootLocation,\n    cacheFolderRelativeLocation,\n    abstractFolderRelativeLocation,\n    filename,\n    branch,\n    asset,\n  })\n  const name = asset.name\n\n  return readFile({\n    location: outputAssetLocation,\n    errorHandler: isFileNotFoundError,\n  }).then(({ content, error }) => {\n    if (error) {\n      return {\n        status: `asset file not found ${outputAssetLocation}`,\n        name,\n      }\n    }\n\n    const actual = createETag(content)\n    const expected = asset.eTag\n    if (actual !== expected) {\n      return {\n        status: `unexpected ${asset.name} asset for ${\n          cache.inputRelativeLocation\n        }: unexpected eTag`,\n        name,\n        content,\n      }\n    }\n    return {\n      status: \"valid\",\n      name,\n      content,\n    }\n  })\n}\n\nconst readBranch = ({\n  rootLocation,\n  cacheFolderRelativeLocation,\n  abstractFolderRelativeLocation,\n  filename,\n  inputLocation,\n  inputETagClient,\n  cache,\n  branch,\n}) => {\n  return Promise.all([\n    readBranchMain({\n      rootLocation,\n      cacheFolderRelativeLocation,\n      abstractFolderRelativeLocation,\n      filename,\n      inputLocation,\n      inputETagClient,\n      cache,\n      branch,\n    }),\n    ...branch.outputAssets.map((outputAsset) => {\n      return readBranchAsset({\n        rootLocation,\n        cacheFolderRelativeLocation,\n        abstractFolderRelativeLocation,\n        filename,\n        cache,\n        branch,\n        asset: outputAsset,\n      })\n    }),\n  ]).then(([mainData, ...assetsData]) => {\n    const { status, input, inputETag, output } = mainData\n\n    let computedStatus\n    if (status === \"valid\") {\n      const invalidAsset = assetsData.find((assetData) => assetData.status !== \"valid\")\n      computedStatus = invalidAsset ? invalidAsset.status : \"valid\"\n    } else {\n      computedStatus = status\n    }\n\n    return {\n      status: computedStatus,\n      input,\n      inputETag,\n      output,\n      outputAssets: assetsData,\n    }\n  })\n}\n\nconst getFileBranch = ({\n  rootLocation,\n  cacheFolderRelativeLocation,\n  abstractFolderRelativeLocation,\n  filename,\n  groupId,\n  compile,\n}) => {\n  const inputRelativeLocation = getInputRelativeLocation({\n    abstractFolderRelativeLocation,\n    filename,\n  })\n\n  const cacheDataLocation = getCacheDataLocation({\n    rootLocation,\n    cacheFolderRelativeLocation,\n    abstractFolderRelativeLocation,\n    filename,\n  })\n\n  return Promise.all([\n    locateFile(inputRelativeLocation, rootLocation),\n    readFile({\n      location: cacheDataLocation,\n      errorHandler: isFileNotFoundError,\n    }).then(({ content, error }) => {\n      if (error) {\n        return {\n          branches: [],\n        }\n      }\n      const cache = JSON.parse(content)\n      if (cache.inputRelativeLocation !== inputRelativeLocation) {\n        throw new Error(\n          `${JSON_FILE} corrupted: unexpected inputRelativeLocation ${\n            cache.inputRelativeLocation\n          }, it must be ${inputRelativeLocation}`,\n        )\n      }\n      return cache\n    }),\n  ])\n    .then(([inputLocation, cache]) => {\n      return {\n        inputLocation,\n        cache,\n      }\n    })\n    .then(({ inputLocation, cache }) => {\n      // here, if readFile returns ENOENT we could/should check is there is something in cache for that file\n      // and take that chance to remove the cached version of that file\n      // but it's not supposed to happen\n      return readFile({\n        location: inputLocation,\n      }).then(({ content }) => {\n        return compile({\n          rootLocation,\n          abstractFolderRelativeLocation,\n          inputRelativeLocation,\n          inputSource: content,\n          filename,\n          groupId,\n          getSourceNameForSourceMap: () => {\n            return filename\n          },\n          getSourceLocationForSourceMap,\n        }).then(({ options, generate }) => {\n          const branchIsValid = (branch) => {\n            return JSON.stringify(branch.outputMeta) === JSON.stringify(options)\n          }\n\n          const cachedBranch = cache.branches.find((branch) => branchIsValid(branch))\n\n          return {\n            inputLocation,\n            cache,\n            options,\n            generate,\n            input: content,\n            branch: cachedBranch,\n          }\n        })\n      })\n    })\n}\n\nconst getFileReport = ({\n  rootLocation,\n  cacheFolderRelativeLocation,\n  abstractFolderRelativeLocation,\n  filename,\n  inputETagClient = null,\n  groupId,\n  compile,\n}) => {\n  return getFileBranch({\n    rootLocation,\n    cacheFolderRelativeLocation,\n    abstractFolderRelativeLocation,\n    filename,\n    groupId,\n    compile,\n  }).then(({ inputLocation, cache, options, generate, input, branch }) => {\n    if (!branch) {\n      return {\n        inputLocation,\n        status: \"missing\",\n        cache,\n        options,\n        generate,\n        branch: {\n          name: cuid(),\n        },\n        input,\n      }\n    }\n\n    return readBranch({\n      rootLocation,\n      cacheFolderRelativeLocation,\n      abstractFolderRelativeLocation,\n      filename,\n      inputLocation,\n      inputETagClient,\n      cache,\n      branch,\n    }).then(({ status, input, output, outputAssets }) => {\n      return {\n        inputLocation,\n        status,\n        cache,\n        options,\n        generate,\n        branch,\n        input,\n        output,\n        outputAssets,\n      }\n    })\n  })\n}\n\nconst compareBranch = (branchA, branchB) => {\n  const lastMatchDiff = branchA.lastMatchMs - branchB.lastMatchMs\n\n  if (lastMatchDiff === 0) {\n    return branchA.matchCount - branchB.matchCount\n  }\n  return lastMatchDiff\n}\n\nconst updateBranch = ({\n  rootLocation,\n  cacheFolderRelativeLocation,\n  abstractFolderRelativeLocation,\n  filename,\n  inputLocation,\n  status,\n  cache,\n  options,\n  branch,\n  inputETag,\n  output,\n  outputAssets,\n  cacheAutoClean,\n  cacheTrackHit,\n}) => {\n  const { branches } = cache\n  const isCached = status === \"cached\"\n  const isNew = status === \"created\"\n  const isUpdated = status === \"updated\"\n\n  const promises = []\n\n  if (isNew || isUpdated) {\n    const mainLocation = getOutputLocation({\n      rootLocation,\n      cacheFolderRelativeLocation,\n      abstractFolderRelativeLocation,\n      filename,\n      branch,\n    })\n\n    promises.push(\n      writeFileFromString(mainLocation, output),\n      ...outputAssets.map((asset) => {\n        const assetLocation = getOutputAssetLocation({\n          rootLocation,\n          cacheFolderRelativeLocation,\n          abstractFolderRelativeLocation,\n          filename,\n          branch,\n          asset,\n        })\n\n        return writeFileFromString(assetLocation, asset.content)\n      }),\n    )\n  }\n\n  if (isNew || isUpdated || (isCached && cacheTrackHit)) {\n    if (cacheAutoClean) {\n      if (inputETag !== cache.inputETag) {\n        const branchesToRemove = branches.slice()\n\n        // no need to remove the updated branch\n        const index = branchesToRemove.indexOf(branch)\n        branchesToRemove.splice(index, 1)\n\n        branches.length = 0\n        branchesToRemove.forEach((branch) => {\n          const branchLocation = getBranchLocation({\n            rootLocation,\n            cacheFolderRelativeLocation,\n            abstractFolderRelativeLocation,\n            filename,\n            branch,\n          })\n          console.log(`file changed, remove ${branchLocation}`)\n          // the line below is async but non blocking\n          removeFolderDeep(branchLocation)\n        })\n      }\n    }\n\n    if (isNew) {\n      branches.push(branch)\n    }\n\n    const updatedBranches = branches\n      .map((branchToUpdate) => {\n        if (branchToUpdate.name !== branch.name) {\n          return { ...branchToUpdate }\n        }\n        if (isCached) {\n          return {\n            ...branchToUpdate,\n            matchCount: branch.matchCount + 1,\n            lastMatchMs: Number(Date.now()),\n          }\n        }\n        if (isUpdated) {\n          return {\n            ...branchToUpdate,\n            matchCount: branch.matchCount + 1,\n            lastMatchMs: Number(Date.now()),\n            lastModifiedMs: Number(Date.now()),\n            outputAssets: outputAssets.map(({ name, content }) => {\n              return { name, eTag: createETag(content) }\n            }),\n          }\n        }\n        // new branch\n        return {\n          name: branch.name,\n          matchCount: 1,\n          createdMs: Number(Date.now()),\n          lastModifiedMs: Number(Date.now()),\n          lastMatchMs: Number(Date.now()),\n          outputMeta: options,\n          outputAssets: outputAssets.map(({ name, content }) => {\n            return { name, eTag: createETag(content) }\n          }),\n        }\n      })\n      .sort(compareBranch)\n\n    const inputRelativeLocation = getInputRelativeLocation({\n      abstractFolderRelativeLocation,\n      filename,\n    })\n\n    const updatedCache = {\n      inputRelativeLocation,\n      inputETag: isCached ? cache.inputETag : inputETag,\n      inputLocation:\n        inputLocation === getSourceAbstractLocation({ rootLocation, inputRelativeLocation })\n          ? undefined\n          : inputLocation,\n      branches: updatedBranches,\n    }\n\n    const cacheDataLocation = getCacheDataLocation({\n      rootLocation,\n      cacheFolderRelativeLocation,\n      abstractFolderRelativeLocation,\n      filename,\n    })\n\n    promises.push(writeFileFromString(cacheDataLocation, JSON.stringify(updatedCache, null, \"  \")))\n  }\n\n  return Promise.all(promises)\n}\n\nconst getFileCompiled = ({\n  rootLocation,\n  cacheFolderRelativeLocation,\n  abstractFolderRelativeLocation,\n  filename,\n  compile,\n  inputETagClient,\n  groupId,\n  getBabelPlugins,\n  cacheEnabled,\n  cacheAutoClean,\n  cacheTrackHit,\n}) => {\n  const fileLock = lockForRessource(\n    getCacheDataLocation({\n      rootLocation,\n      cacheFolderRelativeLocation,\n      abstractFolderRelativeLocation,\n      filename,\n    }),\n  )\n\n  return fileLock.chain(() => {\n    return getFileReport({\n      rootLocation,\n      cacheFolderRelativeLocation,\n      abstractFolderRelativeLocation,\n      filename,\n      inputETagClient,\n      groupId,\n      compile,\n    })\n      .then(\n        ({\n          inputLocation,\n          status,\n          cache,\n          options,\n          generate,\n          branch,\n          input,\n          inputETag,\n          output,\n          outputAssets,\n        }) => {\n          const outputRelativeLocation = getOutputRelativeLocation({\n            cacheFolderRelativeLocation,\n            abstractFolderRelativeLocation,\n            filename,\n            branch,\n          })\n\n          if (cacheEnabled && status === \"valid\") {\n            return {\n              inputLocation,\n              status: \"cached\",\n              cache,\n              options,\n              branch,\n              input,\n              inputETag,\n              outputRelativeLocation,\n              output,\n              outputAssets,\n            }\n          }\n\n          return Promise.resolve(generate({ outputRelativeLocation, getBabelPlugins })).then(\n            ({ output, outputAssets }) => {\n              return {\n                inputLocation,\n                status: status === \"missing\" ? \"created\" : \"updated\",\n                cache,\n                options,\n                branch,\n                input,\n                inputETag: createETag(input),\n                outputRelativeLocation,\n                output,\n                outputAssets,\n              }\n            },\n          )\n        },\n      )\n      .then(\n        ({\n          inputLocation,\n          status,\n          cache,\n          options,\n          branch,\n          input,\n          inputETag,\n          outputRelativeLocation,\n          output,\n          outputAssets,\n        }) => {\n          return updateBranch({\n            rootLocation,\n            cacheFolderRelativeLocation,\n            abstractFolderRelativeLocation,\n            filename,\n            inputLocation,\n            status,\n            cache,\n            options,\n            branch,\n            input,\n            inputETag,\n            output,\n            outputAssets,\n            cacheTrackHit,\n            cacheAutoClean,\n          }).then(() => {\n            return {\n              status,\n              inputETag,\n              output,\n              outputRelativeLocation,\n            }\n          })\n        },\n      )\n  })\n}\n\nexport const createCompileService = ({\n  rootLocation,\n  cacheFolderRelativeLocation = \"build\",\n  abstractFolderRelativeLocation = \"compiled\",\n  compile = createCompile(),\n  cacheEnabled = false,\n  cacheAutoClean = true,\n  cacheTrackHit = false,\n}) => {\n  const fileService = createFileService()\n\n  const { getGroupIdForPlatform, getPluginsFromGroupId } = buildGroup({\n    root: rootLocation,\n  })\n\n  const service = ({ method, url, headers }) => {\n    const pathname = url.pathname\n    // '/compiled/folder/file.js' -> 'compiled/folder/file.js'\n    const filename = pathname.slice(1)\n\n    // je crois, que, normalement\n    // il faudrait \"aider\" le browser pour que tout ça ait du sens\n    // genre lui envoyer une redirection vers le fichier en cache\n    // genre renvoyer 201 vers le cache lorsqu'il a été update ou créé\n    // https://developer.mozilla.org/fr/docs/Web/HTTP/Status/201\n    // renvoyer 302 ou 307 lorsque le cache existe\n    // l'intérêt c'est que si jamais le browser fait une requête vers le cache\n    // il sait à quoi ça correspond vraiment\n    // par contre ça fait 2 requête http\n\n    if (filename.endsWith(\".map\")) {\n      const fileLock = lockForRessource(\n        getCacheDataLocation({\n          rootLocation,\n          cacheFolderRelativeLocation,\n          abstractFolderRelativeLocation,\n          filename,\n        }),\n      )\n\n      return fileLock.chain(() => {\n        const script = filename.slice(0, -4) // 'folder/file.js.map' -> 'folder.file.js'\n\n        // if we receive something like compiled/folder/file.js.map\n        // we redirect to build/folder/file.js/jqjcijjojio/file.js.map\n\n        return getFileBranch({\n          rootLocation,\n          cacheFolderRelativeLocation,\n          abstractFolderRelativeLocation,\n          filename: script,\n          compile,\n        }).then(\n          ({ branch }) => {\n            if (!branch) {\n              return {\n                status: 404,\n              }\n            }\n\n            const outputLocation = getOutputLocation({\n              rootLocation,\n              cacheFolderRelativeLocation,\n              abstractFolderRelativeLocation,\n              filename,\n              branch,\n            })\n\n            return fileService({\n              method,\n              url: new URL(`file:///${outputLocation}${url.search}`),\n              headers,\n            })\n          },\n          (error) => {\n            if (error && error.reason === \"Unexpected directory operation\") {\n              return {\n                status: 403,\n              }\n            }\n            return Promise.reject(error)\n          },\n        )\n      })\n    }\n\n    const { platformName, platformVersion } = getPlatformAndVersionFromHeaders(headers)\n    const groupId = getGroupIdForPlatform({\n      platformName,\n      platformVersion,\n    })\n\n    return getFileCompiled({\n      rootLocation,\n      cacheFolderRelativeLocation,\n      abstractFolderRelativeLocation,\n      filename,\n      compile,\n      inputETagClient: headers.has(\"if-none-match\") ? headers.get(\"if-none-match\") : undefined,\n      groupId,\n      getBabelPlugins: () => getPluginsFromGroupId(groupId),\n      cacheEnabled,\n      cacheAutoClean,\n      cacheTrackHit,\n    }).then(\n      ({ status, inputETag, outputRelativeLocation, output }) => {\n        // here status can be \"created\", \"updated\", \"cached\"\n\n        // c'est un peu optimiste ici de se dire que si c'est cached et qu'on a\n        // if-none-match c'est forcément le etag du client qui a match\n        // faudra changer ça non?\n        if (headers.has(\"if-none-match\") && status === \"cached\") {\n          return {\n            status: 304,\n            headers: {\n              \"cache-control\": \"no-store\",\n              \"x-location\": outputRelativeLocation,\n            },\n          }\n        }\n\n        return {\n          status: 200,\n          headers: {\n            Etag: inputETag,\n            \"content-length\": Buffer.byteLength(output),\n            \"content-type\": \"application/javascript\",\n            \"cache-control\": \"no-store\",\n            \"x-location\": outputRelativeLocation,\n          },\n          body: output,\n        }\n      },\n      (error) => {\n        if (error && error.reason === \"Unexpected directory operation\") {\n          return {\n            status: 403,\n          }\n        }\n        return Promise.reject(error)\n      },\n    )\n  }\n\n  const compileFile = (relativeLocation) =>\n    getFileCompiled({\n      rootLocation,\n      cacheFolderRelativeLocation,\n      abstractFolderRelativeLocation,\n      filename: `${abstractFolderRelativeLocation}/${relativeLocation}`,\n      compile,\n      cacheEnabled,\n      cacheAutoClean,\n      cacheTrackHit,\n    })\n\n  return { service, compileFile }\n}\n"
  ]
}