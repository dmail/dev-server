{
  "version": 3,
  "sources": [
    "../../../src/createLock/createLock.js"
  ],
  "names": [
    "createLock",
    "unusedCallback",
    "onceUnused",
    "callback",
    "pendings",
    "busy",
    "chain",
    "promise",
    "resolve",
    "reject",
    "push",
    "Promise",
    "then",
    "fullfilledOrRejected",
    "length",
    "undefined",
    "shift",
    "createLockRegistry",
    "lockBindings",
    "lockForRessource",
    "ressource",
    "lockBinding",
    "find",
    "lock",
    "index",
    "indexOf",
    "splice"
  ],
  "mappings": ";;;;;;;AAAA;;AAEA,MAAMA,UAAU,GAAG,MAAM;AACvB,MAAIC,cAAJ;;AACA,QAAMC,UAAU,GAAIC,QAAD,IAAc;AAC/BF,IAAAA,cAAc,GAAGE,QAAjB;AACD,GAFD;;AAIA,QAAMC,QAAQ,GAAG,EAAjB;AACA,MAAIC,IAAI,GAAG,KAAX;;AAEA,QAAMC,KAAK,GAAIH,QAAD,IAAc;AAC1B,QAAIE,IAAJ,EAAU;AACR,YAAM;AAAEE,QAAAA,OAAF;AAAWC,QAAAA,OAAX;AAAoBC,QAAAA;AAApB,UAA+B,qCAArC;AACAL,MAAAA,QAAQ,CAACM,IAAT,CAAc;AAAEH,QAAAA,OAAF;AAAWC,QAAAA,OAAX;AAAoBC,QAAAA,MAApB;AAA4BN,QAAAA;AAA5B,OAAd;AACA,aAAOI,OAAP;AACD;;AAEDF,IAAAA,IAAI,GAAG,IAAP;AACA,UAAME,OAAO,GAAGI,OAAO,CAACH,OAAR,GAAkBI,IAAlB,CAAuBT,QAAvB,CAAhB;;AAEA,UAAMU,oBAAoB,GAAG,MAAM;AACjCR,MAAAA,IAAI,GAAG,KAAP;;AACA,UAAID,QAAQ,CAACU,MAAT,KAAoB,CAAxB,EAA2B;AACzB,YAAIb,cAAJ,EAAoB;AAClBA,UAAAA,cAAc;AACdA,UAAAA,cAAc,GAAGc,SAAjB;AACD;AACF,OALD,MAKO;AACL,cAAM;AAAEP,UAAAA,OAAF;AAAWL,UAAAA;AAAX,YAAwBC,QAAQ,CAACY,KAAT,EAA9B;AACAR,QAAAA,OAAO,CAACF,KAAK,CAACH,QAAD,CAAN,CAAP;AACD;AACF,KAXD;;AAaAI,IAAAA,OAAO,CAACK,IAAR,CAAaC,oBAAb,EAAmCA,oBAAnC;AAEA,WAAON,OAAP;AACD,GA1BD;;AA4BA,SAAO;AAAED,IAAAA,KAAF;AAASJ,IAAAA;AAAT,GAAP;AACD,CAtCD;;AAwCO,MAAMe,kBAAkB,GAAG,MAAM;AACtC,QAAMC,YAAY,GAAG,EAArB;;AACA,QAAMC,gBAAgB,GAAIC,SAAD,IAAe;AACtC,UAAMC,WAAW,GAAGH,YAAY,CAACI,IAAb,CAAmBD,WAAD,IAAiBA,WAAW,CAACD,SAAZ,KAA0BA,SAA7D,CAApB;;AACA,QAAIC,WAAJ,EAAiB;AACf,aAAOA,WAAW,CAACE,IAAnB;AACD;;AAED,UAAMA,IAAI,GAAGvB,UAAU,EAAvB;AACAkB,IAAAA,YAAY,CAACR,IAAb,CAAkB;AAChBa,MAAAA,IADgB;AAEhBH,MAAAA;AAFgB,KAAlB,EAPsC,CAWtC;AACA;;AACAG,IAAAA,IAAI,CAACrB,UAAL,CAAgB,MAAM;AACpB,YAAMsB,KAAK,GAAGN,YAAY,CAACO,OAAb,CAAqBF,IAArB,CAAd;AACAL,MAAAA,YAAY,CAACQ,MAAb,CAAoBF,KAApB,EAA2B,CAA3B;AACD,KAHD;AAKA,WAAOD,IAAP;AACD,GAnBD;;AAoBA,SAAO;AAAEJ,IAAAA;AAAF,GAAP;AACD,CAvBM",
  "sourcesContent": [
    "import { createPromiseAndHooks } from \"../promise.js\"\n\nconst createLock = () => {\n  let unusedCallback\n  const onceUnused = (callback) => {\n    unusedCallback = callback\n  }\n\n  const pendings = []\n  let busy = false\n\n  const chain = (callback) => {\n    if (busy) {\n      const { promise, resolve, reject } = createPromiseAndHooks()\n      pendings.push({ promise, resolve, reject, callback })\n      return promise\n    }\n\n    busy = true\n    const promise = Promise.resolve().then(callback)\n\n    const fullfilledOrRejected = () => {\n      busy = false\n      if (pendings.length === 0) {\n        if (unusedCallback) {\n          unusedCallback()\n          unusedCallback = undefined\n        }\n      } else {\n        const { resolve, callback } = pendings.shift()\n        resolve(chain(callback))\n      }\n    }\n\n    promise.then(fullfilledOrRejected, fullfilledOrRejected)\n\n    return promise\n  }\n\n  return { chain, onceUnused }\n}\n\nexport const createLockRegistry = () => {\n  const lockBindings = []\n  const lockForRessource = (ressource) => {\n    const lockBinding = lockBindings.find((lockBinding) => lockBinding.ressource === ressource)\n    if (lockBinding) {\n      return lockBinding.lock\n    }\n\n    const lock = createLock()\n    lockBindings.push({\n      lock,\n      ressource,\n    })\n    // to avoid lockBindings to grow for ever\n    // we remove them from the array as soon as the ressource is not used anymore\n    lock.onceUnused(() => {\n      const index = lockBindings.indexOf(lock)\n      lockBindings.splice(index, 1)\n    })\n\n    return lock\n  }\n  return { lockForRessource }\n}\n"
  ]
}