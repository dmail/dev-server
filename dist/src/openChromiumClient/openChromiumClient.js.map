{
  "version": 3,
  "sources": [
    "../../../src/openChromiumClient/openChromiumClient.js"
  ],
  "names": [
    "openIndexRequestInterception",
    "url",
    "page",
    "body",
    "setRequestInterception",
    "then",
    "on",
    "interceptedRequest",
    "startsWith",
    "respond",
    "status",
    "contentType",
    "headers",
    "Buffer",
    "byteLength",
    "close",
    "openChromiumClient",
    "server",
    "compileURL",
    "openIndexRequestHandler",
    "openIndexServer",
    "headless",
    "mirrorConsole",
    "runFile",
    "serverURL",
    "file",
    "setup",
    "teardown",
    "evaluate",
    "compileRoot",
    "setupSource",
    "teardownSource",
    "evtSource",
    "EventSource",
    "addEventListener",
    "e",
    "console",
    "log",
    "Promise",
    "resolve",
    "eval",
    "window",
    "System",
    "import",
    "href",
    "toString",
    "Error",
    "openBrowser",
    "puppeteer",
    "launch",
    "ignoreHTTPSErrors",
    "execute",
    "autoClose",
    "autoCloseOnError",
    "collectCoverage",
    "executeTest",
    "closed",
    "emit",
    "promise",
    "browser",
    "listen",
    "newPage",
    "createPageUnexpectedBranch",
    "reject",
    "createPageExpectedBranch",
    "message",
    "_type",
    "_text",
    "title",
    "html",
    "indexRequestHandler",
    "remoteFile",
    "goto",
    "String",
    "race",
    "value",
    "reason"
  ],
  "mappings": "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",
  "sourcesContent": [
    "import puppeteer from \"puppeteer\"\nimport { createHTMLForBrowser } from \"../createHTMLForBrowser.js\"\nimport { openIndexServer } from \"../openIndexServer/openIndexServer.js\"\nimport { getRemoteLocation } from \"../getRemoteLocation.js\"\nimport { getBrowserSetupAndTeardowm } from \"../getClientSetupAndTeardown.js\"\nimport { createSignal } from \"@dmail/signal\"\n\nconst openIndexRequestInterception = ({ url, page, body }) => {\n  return page\n    .setRequestInterception(true)\n    .then(() => {\n      page.on(\"request\", (interceptedRequest) => {\n        if (interceptedRequest.url().startsWith(url)) {\n          interceptedRequest.respond({\n            status: 200,\n            contentType: \"text/html\",\n            headers: {\n              \"content-type\": \"text/html\",\n              \"content-length\": Buffer.byteLength(body),\n              \"cache-control\": \"no-store\",\n            },\n            body,\n          })\n          return\n        }\n      })\n    })\n    .then(() => {\n      return {\n        url,\n        close: () => page.setRequestInterception(false),\n      }\n    })\n}\n\nexport const openChromiumClient = ({\n  url = \"https://127.0.0.1:0\",\n  server,\n  compileURL,\n  openIndexRequestHandler = openIndexServer,\n  headless = true,\n  mirrorConsole = false,\n  runFile = ({ serverURL, page, file, setup, teardown }) => {\n    return page.evaluate(\n      (compileRoot, file, setupSource, teardownSource) => {\n        const evtSource = new EventSource(compileRoot)\n        evtSource.addEventListener(\"message\", (e) => {\n          console.log(\"received event\", e)\n        })\n\n        return Promise.resolve(file)\n          .then(eval(setupSource))\n          .then(() => window.System.import(file))\n          .then(eval(teardownSource))\n      },\n      serverURL.href,\n      file,\n      `(${setup.toString()})`,\n      `(${teardown.toString()})`,\n    )\n  },\n}) => {\n  if (openIndexRequestHandler === openIndexRequestInterception && headless === false) {\n    throw new Error(`openIndexRequestInterception work only in headless mode`)\n  }\n\n  const openBrowser = () => {\n    return puppeteer.launch({\n      headless,\n      ignoreHTTPSErrors: true, // because we use a self signed certificate\n      // handleSIGINT: true,\n      // handleSIGTERM: true,\n      // handleSIGHUP: true,\n      // because the 3 above are true by default pupeeter will auto close browser\n      // so we apparently don't have to use listenNodeBeforeExit in order to close browser\n      // as we do for server\n    })\n  }\n\n  // https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md\n  const execute = ({\n    file,\n    autoClose = false,\n    // autoCloseOnError is different than autoClose because you often want to keep browser opened to debug error\n    autoCloseOnError = false,\n    collectCoverage = false,\n    executeTest = false,\n  }) => {\n    const closed = createSignal()\n\n    const close = () => {\n      closed.emit()\n    }\n\n    const promise = openBrowser()\n      .then((browser) => {\n        closed.listen(() => {\n          browser.close()\n        })\n\n        return browser.newPage().then((page) => {\n          closed.listen(() => {\n            // page.close() // commented until https://github.com/GoogleChrome/puppeteer/issues/2269\n          })\n\n          const createPageUnexpectedBranch = (page) => {\n            return new Promise((resolve, reject) => {\n              // https://github.com/GoogleChrome/puppeteer/blob/v1.4.0/docs/api.md#event-error\n              page.on(\"error\", reject)\n              // https://github.com/GoogleChrome/puppeteer/blob/v1.4.0/docs/api.md#event-pageerror\n              page.on(\"pageerror\", reject)\n            })\n          }\n\n          const createPageExpectedBranch = (page) => {\n            if (mirrorConsole) {\n              page.on(\"console\", (message) => {\n                // there is also message._args\n                // which is an array of JSHandle{ _context, _client _remoteObject }\n                console[message._type](message._text)\n              })\n            }\n\n            return createHTMLForBrowser({\n              title: \"Skeleton for Chromium\",\n            }).then((html) => {\n              return openIndexRequestHandler({\n                url,\n                page,\n                body: html,\n              }).then((indexRequestHandler) => {\n                closed.listen(() => {\n                  indexRequestHandler.close()\n                })\n\n                const remoteFile = getRemoteLocation({\n                  compileURL,\n                  file,\n                })\n\n                return page.goto(String(indexRequestHandler.url)).then(() =>\n                  runFile({\n                    serverURL: server.url,\n                    page,\n                    file: remoteFile,\n                    ...getBrowserSetupAndTeardowm({ collectCoverage, executeTest }),\n                  }),\n                )\n              })\n            })\n          }\n\n          return Promise.race([createPageUnexpectedBranch(page), createPageExpectedBranch(page)])\n        })\n      })\n      .then(\n        (value) => {\n          if (autoClose) {\n            close()\n          }\n          return value\n        },\n        (reason) => {\n          if (autoCloseOnError) {\n            close()\n          }\n          return Promise.reject(reason)\n        },\n      )\n\n    return Promise.resolve({\n      promise,\n      close,\n    })\n  }\n\n  return Promise.resolve({ execute })\n}\n"
  ]
}