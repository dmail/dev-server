{
  "version": 3,
  "sources": [
    "../../../src/openChromiumClient/openChromiumClient.js"
  ],
  "names": [
    "openIndexRequestInterception",
    "url",
    "page",
    "body",
    "setRequestInterception",
    "then",
    "on",
    "interceptedRequest",
    "startsWith",
    "respond",
    "status",
    "contentType",
    "headers",
    "Buffer",
    "byteLength",
    "close",
    "openChromiumClient",
    "puppeteer",
    "server",
    "compileURL",
    "openIndexRequestHandler",
    "openIndexServer",
    "headless",
    "mirrorConsole",
    "runFile",
    "serverURL",
    "file",
    "setup",
    "teardown",
    "evaluate",
    "compileRoot",
    "setupSource",
    "teardownSource",
    "evtSource",
    "EventSource",
    "addEventListener",
    "e",
    "console",
    "log",
    "Promise",
    "resolve",
    "eval",
    "window",
    "System",
    "import",
    "href",
    "toString",
    "Error",
    "openBrowser",
    "launch",
    "ignoreHTTPSErrors",
    "execute",
    "autoClose",
    "autoCloseOnError",
    "collectCoverage",
    "executeTest",
    "closed",
    "emit",
    "promise",
    "browser",
    "listen",
    "newPage",
    "createPageUnexpectedBranch",
    "reject",
    "createPageExpectedBranch",
    "message",
    "_type",
    "_text",
    "title",
    "html",
    "indexRequestHandler",
    "remoteFile",
    "goto",
    "String",
    "race",
    "value",
    "reason"
  ],
  "mappings": "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",
  "sourcesContent": [
    "import { createHTMLForBrowser } from \"../createHTMLForBrowser.js\"\nimport { openIndexServer } from \"../openIndexServer/openIndexServer.js\"\nimport { getRemoteLocation } from \"../getRemoteLocation.js\"\nimport { getBrowserSetupAndTeardowm } from \"../getClientSetupAndTeardown.js\"\nimport { createSignal } from \"@dmail/signal\"\n\nconst openIndexRequestInterception = ({ url, page, body }) => {\n  return page\n    .setRequestInterception(true)\n    .then(() => {\n      page.on(\"request\", (interceptedRequest) => {\n        if (interceptedRequest.url().startsWith(url)) {\n          interceptedRequest.respond({\n            status: 200,\n            contentType: \"text/html\",\n            headers: {\n              \"content-type\": \"text/html\",\n              \"content-length\": Buffer.byteLength(body),\n              \"cache-control\": \"no-store\",\n            },\n            body,\n          })\n          return\n        }\n      })\n    })\n    .then(() => {\n      return {\n        url,\n        close: () => page.setRequestInterception(false),\n      }\n    })\n}\n\nexport const openChromiumClient = ({\n  puppeteer,\n  url = \"https://127.0.0.1:0\",\n  server,\n  compileURL,\n  openIndexRequestHandler = openIndexServer,\n  headless = true,\n  mirrorConsole = false,\n  runFile = ({ serverURL, page, file, setup, teardown }) => {\n    return page.evaluate(\n      (compileRoot, file, setupSource, teardownSource) => {\n        const evtSource = new EventSource(compileRoot)\n        evtSource.addEventListener(\"message\", (e) => {\n          console.log(\"received event\", e)\n        })\n\n        return Promise.resolve(file)\n          .then(eval(setupSource))\n          .then(() => window.System.import(file))\n          .then(eval(teardownSource))\n      },\n      serverURL.href,\n      file,\n      `(${setup.toString()})`,\n      `(${teardown.toString()})`,\n    )\n  },\n}) => {\n  if (openIndexRequestHandler === openIndexRequestInterception && headless === false) {\n    throw new Error(`openIndexRequestInterception work only in headless mode`)\n  }\n\n  const openBrowser = () => {\n    return puppeteer.launch({\n      headless,\n      ignoreHTTPSErrors: true, // because we use a self signed certificate\n      // handleSIGINT: true,\n      // handleSIGTERM: true,\n      // handleSIGHUP: true,\n      // because the 3 above are true by default pupeeter will auto close browser\n      // so we apparently don't have to use listenNodeBeforeExit in order to close browser\n      // as we do for server\n    })\n  }\n\n  // https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md\n  const execute = ({\n    file,\n    autoClose = false,\n    // autoCloseOnError is different than autoClose because you often want to keep browser opened to debug error\n    autoCloseOnError = false,\n    collectCoverage = false,\n    executeTest = false,\n  }) => {\n    const closed = createSignal()\n\n    const close = () => {\n      closed.emit()\n    }\n\n    const promise = openBrowser()\n      .then((browser) => {\n        closed.listen(() => {\n          browser.close()\n        })\n\n        return browser.newPage().then((page) => {\n          closed.listen(() => {\n            // page.close() // commented until https://github.com/GoogleChrome/puppeteer/issues/2269\n          })\n\n          const createPageUnexpectedBranch = (page) => {\n            return new Promise((resolve, reject) => {\n              // https://github.com/GoogleChrome/puppeteer/blob/v1.4.0/docs/api.md#event-error\n              page.on(\"error\", reject)\n              // https://github.com/GoogleChrome/puppeteer/blob/v1.4.0/docs/api.md#event-pageerror\n              page.on(\"pageerror\", reject)\n            })\n          }\n\n          const createPageExpectedBranch = (page) => {\n            if (mirrorConsole) {\n              page.on(\"console\", (message) => {\n                // there is also message._args\n                // which is an array of JSHandle{ _context, _client _remoteObject }\n                console[message._type](message._text)\n              })\n            }\n\n            return createHTMLForBrowser({\n              title: \"Skeleton for Chromium\",\n            }).then((html) => {\n              return openIndexRequestHandler({\n                url,\n                page,\n                body: html,\n              }).then((indexRequestHandler) => {\n                closed.listen(() => {\n                  indexRequestHandler.close()\n                })\n\n                const remoteFile = getRemoteLocation({\n                  compileURL,\n                  file,\n                })\n\n                return page.goto(String(indexRequestHandler.url)).then(() =>\n                  runFile({\n                    serverURL: server.url,\n                    page,\n                    file: remoteFile,\n                    ...getBrowserSetupAndTeardowm({ collectCoverage, executeTest }),\n                  }),\n                )\n              })\n            })\n          }\n\n          return Promise.race([createPageUnexpectedBranch(page), createPageExpectedBranch(page)])\n        })\n      })\n      .then(\n        (value) => {\n          if (autoClose) {\n            close()\n          }\n          return value\n        },\n        (reason) => {\n          if (autoCloseOnError) {\n            close()\n          }\n          return Promise.reject(reason)\n        },\n      )\n\n    return Promise.resolve({\n      promise,\n      close,\n    })\n  }\n\n  return Promise.resolve({ execute })\n}\n"
  ]
}