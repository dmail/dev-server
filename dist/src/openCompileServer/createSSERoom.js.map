{
  "version": 3,
  "sources": [
    "../../../src/openCompileServer/createSSERoom.js"
  ],
  "names": [
    "stringifySourceEvent",
    "data",
    "type",
    "id",
    "retry",
    "string",
    "undefined",
    "createEventHistory",
    "limit",
    "events",
    "removedCount",
    "add",
    "push",
    "length",
    "shift",
    "since",
    "index",
    "parseInt",
    "isNaN",
    "TypeError",
    "slice",
    "reset",
    "createSSERoom",
    "keepaliveDuration",
    "retryDuration",
    "historyLength",
    "maxLength",
    "connections",
    "Set",
    "history",
    "lastEventId",
    "state",
    "interval",
    "connect",
    "size",
    "status",
    "joinEvent",
    "Date",
    "toLocaleTimeString",
    "connection",
    "closed",
    "listen",
    "console",
    "log",
    "delete",
    "forEach",
    "event",
    "write",
    "headers",
    "body",
    "sendEvent",
    "keepAlive",
    "open",
    "setInterval",
    "close",
    "clearInterval"
  ],
  "mappings": "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",
  "sourcesContent": [
    "import { createBody } from \"../openServer/createBody.js\"\n\n// https://github.com/dmail-old/project/commit/da7d2c88fc8273850812972885d030a22f9d7448\n// https://github.com/dmail-old/project/commit/98b3ae6748d461ac4bd9c48944a551b1128f4459\n\n// https://github.com/dmail-old/http-eventsource/blob/master/lib/event-source.js\n\n// http://html5doctor.com/server-sent-events/\nconst stringifySourceEvent = ({ data, type = \"message\", id, retry }) => {\n  let string = \"\"\n\n  if (id !== undefined) {\n    string += `id:${id}\\n`\n  }\n\n  if (retry) {\n    string += `retry:${retry}\\n`\n  }\n\n  if (type !== \"message\") {\n    string += `event:${type}\\n`\n  }\n\n  string += `data:${data}\\n\\n`\n\n  return string\n}\n\nconst createEventHistory = ({ limit } = {}) => {\n  const events = []\n  let removedCount = 0\n\n  const add = (data) => {\n    events.push(data)\n\n    if (events.length >= limit) {\n      events.shift()\n      removedCount++\n    }\n  }\n\n  const since = (index) => {\n    index = parseInt(index)\n    if (isNaN(index)) {\n      throw new TypeError(\"history.since() expect a number\")\n    }\n    index -= removedCount\n    return index < 0 ? [] : events.slice(index)\n  }\n\n  const reset = () => {\n    events.length = 0\n    removedCount = 0\n  }\n\n  return { add, since, reset }\n}\n\n// https://www.html5rocks.com/en/tutorials/eventsource/basics/\nexport const createSSERoom = (\n  {\n    keepaliveDuration = 30000,\n    retryDuration = 1000,\n    historyLength = 1000,\n    maxLength = 100, // max 100 users accepted\n  } = {},\n) => {\n  const connections = new Set()\n  const history = createEventHistory(historyLength)\n  let lastEventId = 0\n  let state = \"closed\"\n  let interval\n\n  const connect = (lastEventId) => {\n    if (connections.size > maxLength) {\n      return {\n        status: 503,\n      }\n    }\n    if (state === \"closed\") {\n      return {\n        status: 204,\n      }\n    }\n\n    const joinEvent = {\n      id: lastEventId,\n      retry: retryDuration,\n      type: \"join\",\n      data: new Date().toLocaleTimeString(),\n    }\n    lastEventId++\n    history.add(joinEvent)\n\n    const events = [\n      joinEvent,\n      // send events which occured between lastEventId & now\n      ...(lastEventId === undefined ? [] : history.since(lastEventId)),\n    ]\n\n    const connection = createBody()\n    connections.add(connection)\n    connection.closed.listen(() => {\n      console.log(\n        `client disconnected, number of client connected to event source: ${connections.size}`,\n      )\n      connections.delete(connection)\n    })\n\n    console.log(\n      `client joined, number of client connected to event source: ${\n        connections.size\n      }, max allowed: ${maxLength}`,\n    )\n\n    events.forEach((event) => {\n      console.log(`send ${event.type} event to this new client`)\n      connection.write(stringifySourceEvent(event))\n    })\n\n    return {\n      status: 200,\n      headers: {\n        \"content-type\": \"text/event-stream\",\n        \"cache-control\": \"no-cache\",\n        connection: \"keep-alive\",\n      },\n      body: connection,\n    }\n  }\n\n  const write = (data) => {\n    connections.forEach((connection) => {\n      connection.write(data)\n    })\n  }\n\n  const sendEvent = (event) => {\n    if (event.type !== \"comment\") {\n      console.log(\n        `send ${event.type} event, number of client listening event source: ${connections.size}`,\n      )\n      event.id = lastEventId\n      lastEventId++\n      history.add(event)\n    }\n\n    write(stringifySourceEvent(event))\n  }\n\n  const keepAlive = () => {\n    // maybe that, when an event occurs, we can delay the keep alive event\n    console.log(\n      `send keep alive event, number of client listening event source: ${connections.size}`,\n    )\n    sendEvent({\n      type: \"comment\",\n      data: new Date().toLocaleTimeString(),\n    })\n  }\n\n  const open = () => {\n    interval = setInterval(keepAlive, keepaliveDuration)\n    state = \"opened\"\n  }\n\n  const close = () => {\n    // it should close every connection no?\n    clearInterval(interval)\n    history.reset()\n    state = \"closed\"\n  }\n\n  return { open, close, connect, sendEvent }\n}\n"
  ]
}