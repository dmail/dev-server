{
  "version": 3,
  "sources": [
    "../../../src/openCompileServer/openCompileServer.js"
  ],
  "names": [
    "guard",
    "fn",
    "shield",
    "undefined",
    "getRequiredHelper",
    "rootLocation",
    "instrument",
    "root",
    "then",
    "getMetaForLocation",
    "instrumentPredicate",
    "inputRelativeLocation",
    "Boolean",
    "cover",
    "Promise",
    "resolve",
    "openCompileServer",
    "url",
    "autoCloseOnExit",
    "autoCloseOnCrash",
    "autoCloseOnError",
    "watch",
    "cacheFolderRelativeLocation",
    "abstractFolderRelativeLocation",
    "cors",
    "transpile",
    "sourceMap",
    "sourceURL",
    "minify",
    "optimize",
    "all",
    "helper",
    "server",
    "createWatchServices",
    "fileChangedSSE",
    "open",
    "watchedFiles",
    "Map",
    "closed",
    "listenOnce",
    "forEach",
    "closeWatcher",
    "clear",
    "close",
    "watchPredicate",
    "relativeFilename",
    "endsWith",
    "headers",
    "get",
    "connect",
    "pathname",
    "slice",
    "dirname",
    "indexOf",
    "length",
    "filename",
    "has",
    "fileWatcher",
    "sendEvent",
    "type",
    "data",
    "set",
    "compileFileFromCompileService",
    "createCompileServiceCustom",
    "compile",
    "createOptions",
    "remap",
    "remapMethod",
    "identify",
    "identifyMethod",
    "trackHit",
    "compileService",
    "service",
    "compileFile",
    "method",
    "createFileServiceCustom",
    "fileService",
    "previousFileService",
    "props",
    "fileURL",
    "URL",
    "handler",
    "services",
    "addRequestHandler",
    "response",
    "compileURL"
  ],
  "mappings": ";;;;;;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,KAAK,GAAG,SAARA,KAAQ,CAACC,EAAD,EAAKC,MAAL;AAAA,SAAgB,YAAa;AACzC,WAAOA,MAAM,MAAN,sBAAkBD,EAAE,MAAF,mBAAlB,GAAgCE,SAAvC;AACD,GAFa;AAAA,CAAd;;AAIA,IAAMC,iBAAiB,GAAG,SAApBA,iBAAoB,OAAkC;AAAA,MAA/BC,YAA+B,QAA/BA,YAA+B;AAAA,MAAjBC,UAAiB,QAAjBA,UAAiB;;AAC1D,MAAIA,UAAJ,EAAgB;AACd,WAAO,kCAAW;AAChBC,MAAAA,IAAI,EAAEF;AADU,KAAX,EAEJG,IAFI,CAEC,iBAA4B;AAAA,UAAzBC,kBAAyB,SAAzBA,kBAAyB;;AAClC,UAAMC,mBAAmB,GAAG,SAAtBA,mBAAsB,QAA+B;AAAA,YAA5BC,qBAA4B,SAA5BA,qBAA4B;AACzD,eAAOC,OAAO,CAACH,kBAAkB,CAACE,qBAAD,CAAlB,CAA0CE,KAA3C,CAAd;AACD,OAFD;;AAIA,aAAO;AAAEH,QAAAA,mBAAmB,EAAnBA;AAAF,OAAP;AACD,KARM,CAAP;AASD;;AACD,SAAOI,OAAO,CAACC,OAAR,CAAgB,EAAhB,CAAP;AACD,CAbD;;AAeO,IAAMC,iBAAiB,GAAG,SAApBA,iBAAoB,QAkB3B;AAAA,MAhBJC,GAgBI,SAhBJA,GAgBI;AAAA,MAfJC,eAeI,SAfJA,eAeI;AAAA,MAdJC,gBAcI,SAdJA,gBAcI;AAAA,MAbJC,gBAaI,SAbJA,gBAaI;AAAA,0BAZJC,KAYI;AAAA,MAZJA,KAYI,4BAZI,KAYJ;AAAA,MAVJhB,YAUI,SAVJA,YAUI;AAAA,oCATJiB,2BASI;AAAA,MATJA,2BASI,sCAT0B,OAS1B;AAAA,oCARJC,8BAQI;AAAA,MARJA,8BAQI,sCAR6B,UAQ7B;AAAA,yBAPJC,IAOI;AAAA,MAPJA,IAOI,2BAPG,IAOH;AAAA,8BANJC,SAMI;AAAA,MANJA,SAMI,gCANQ,IAMR;AAAA,8BALJC,SAKI;AAAA,MALJA,SAKI,gCALQ,SAKR;AAAA,8BAJJC,SAII;AAAA,MAJJA,SAII,gCAJQ,IAIR;AAAA,2BAHJC,MAGI;AAAA,MAHJA,MAGI,6BAHK,KAGL;AAAA,6BAFJC,QAEI;AAAA,MAFJA,QAEI,+BAFO,KAEP;AAAA,+BADJvB,UACI;AAAA,MADJA,UACI,iCADS,KACT;AACJ,SAAOQ,OAAO,CAACgB,GAAR,CAAY,CACjB1B,iBAAiB,CAAC;AAAEC,IAAAA,YAAY,EAAZA,YAAF;AAAgBC,IAAAA,UAAU,EAAVA;AAAhB,GAAD,CADA,EAEjB,4BAAW;AACTW,IAAAA,GAAG,EAAHA,GADS;AAETC,IAAAA,eAAe,EAAfA,eAFS;AAGTC,IAAAA,gBAAgB,EAAhBA,gBAHS;AAITC,IAAAA,gBAAgB,EAAhBA;AAJS,GAAX,CAFiB,CAAZ,EASJZ,IATI,CASC,iBAAsB;AAAA;AAAA,QAApBuB,MAAoB;AAAA,QAAZC,MAAY;;AAC1B;AACEA,MAAAA,MAAM,EAANA;AADF,OAEKD,MAFL;AAID,GAdI,EAeJvB,IAfI,CAeC,iBAAqC;AAAA,QAAlCwB,MAAkC,SAAlCA,MAAkC;AAAA,QAA1BtB,mBAA0B,SAA1BA,mBAA0B;;AACzC,QAAMuB,mBAAmB,GAAG,SAAtBA,mBAAsB,GAAM;AAChC;AAEA,UAAMC,cAAc,GAAG,mCAAvB;AACAA,MAAAA,cAAc,CAACC,IAAf;AACA,UAAMC,YAAY,GAAG,IAAIC,GAAJ,EAArB;AACAL,MAAAA,MAAM,CAACM,MAAP,CAAcC,UAAd,CAAyB,YAAM;AAC7BH,QAAAA,YAAY,CAACI,OAAb,CAAqB,UAACC,YAAD;AAAA,iBAAkBA,YAAY,EAA9B;AAAA,SAArB;AACAL,QAAAA,YAAY,CAACM,KAAb;AACAR,QAAAA,cAAc,CAACS,KAAf;AACD,OAJD;;AAKA,UAAMC,cAAc,GAAG,SAAjBA,cAAiB,CAACC,gBAAD,EAAsB;AAC3C;AACA,eAAOA,gBAAgB,CAACC,QAAjB,CAA0B,KAA1B,CAAP;AACD,OAHD;;AAKA,aAAO,CACL,iBAAiB;AAAA,YAAdC,OAAc,SAAdA,OAAc;;AACf,YAAIA,OAAO,CAACC,GAAR,CAAY,QAAZ,MAA0B,mBAA9B,EAAmD;AACjD,iBAAOd,cAAc,CAACe,OAAf,CAAuBF,OAAO,CAACC,GAAR,CAAY,eAAZ,CAAvB,CAAP;AACD;;AACD,eAAO,IAAP;AACD,OANI,EAOL,iBAAa;AAAA,YAAV/B,GAAU,SAAVA,GAAU;AACX,YAAI4B,gBAAgB,GAAG5B,GAAG,CAACiC,QAAJ,CAAaC,KAAb,CAAmB,CAAnB,CAAvB;AACA,YAAMC,OAAO,GAAGP,gBAAgB,CAACM,KAAjB,CAAuB,CAAvB,EAA0BN,gBAAgB,CAACQ,OAAjB,CAAyB,GAAzB,CAA1B,CAAhB;;AACA,YAAID,OAAO,KAAK7B,8BAAhB,EAAgD;AAC9C;AACAsB,UAAAA,gBAAgB,GAAGA,gBAAgB,CAACM,KAAjB,CAAuB5B,8BAA8B,CAAC+B,MAA/B,GAAwC,CAA/D,CAAnB;AACD;;AAED,YAAMC,QAAQ,aAAMlD,YAAN,cAAsBwC,gBAAtB,CAAd;;AAEA,YAAIT,YAAY,CAACoB,GAAb,CAAiBD,QAAjB,MAA+B,KAA/B,IAAwCX,cAAc,CAACC,gBAAD,CAA1D,EAA8E;AAC5E,cAAMY,WAAW,GAAG,0BAAUF,QAAV,EAAoB,YAAM;AAC5CrB,YAAAA,cAAc,CAACwB,SAAf,CAAyB;AACvBC,cAAAA,IAAI,EAAE,cADiB;AAEvBC,cAAAA,IAAI,EAAEf;AAFiB,aAAzB;AAID,WALmB,CAApB;AAMAT,UAAAA,YAAY,CAACyB,GAAb,CAAiB5C,GAAjB,EAAsBwC,WAAtB;AACD;AACF,OA1BI,CAAP;AA4BD,KA5CD;;AA8CA,QAAIK,6BAAJ;;AACA,QAAMC,0BAA0B,GAAG,SAA7BA,0BAA6B,GAAM;AACvC,UAAMC,OAAO,GAAG,kCAAc;AAC5BtD,QAAAA,mBAAmB,EAAnBA,mBAD4B;AAE5BuD,QAAAA,aAAa,EAAE,yBAAM;AACnB;AACA;AACA;AACA;AACA;AAEA,cAAMC,KAAK,GAAGxC,SAAS,KAAK,SAAd,IAA2BA,SAAS,KAAK,QAAvD;AACA,cAAMyC,WAAW,GAAGzC,SAApB;AAEA,cAAM0C,QAAQ,GAAGzC,SAAjB;AACA,cAAM0C,cAAc,GAAG,UAAvB;AAEA,iBAAO;AACLD,YAAAA,QAAQ,EAARA,QADK;AAELC,YAAAA,cAAc,EAAdA,cAFK;AAGL5C,YAAAA,SAAS,EAATA,SAHK;AAILnB,YAAAA,UAAU,EAAVA,UAJK;AAKL4D,YAAAA,KAAK,EAALA,KALK;AAMLC,YAAAA,WAAW,EAAXA,WANK;AAOLvC,YAAAA,MAAM,EAANA,MAPK;AAQLC,YAAAA,QAAQ,EAARA;AARK,WAAP;AAUD;AAzB2B,OAAd,CAAhB;;AADuC,kCA4BU,iCAAqB;AACpExB,QAAAA,YAAY,EAAZA,YADoE;AAEpEiB,QAAAA,2BAA2B,EAA3BA,2BAFoE;AAGpEC,QAAAA,8BAA8B,EAA9BA,8BAHoE;AAIpE+C,QAAAA,QAAQ,EAAE,IAJ0D;AAKpEN,QAAAA,OAAO,EAAPA;AALoE,OAArB,CA5BV;AAAA,UA4BtBO,cA5BsB,yBA4B/BC,OA5B+B;AAAA,UA4BNC,WA5BM,yBA4BNA,WA5BM;;AAmCvCX,MAAAA,6BAA6B,GAAGW,WAAhC;AAEA,aAAOzE,KAAK,CAACuE,cAAD,EAAiB,kBAAqB;AAAA,YAAlBG,MAAkB,UAAlBA,MAAkB;AAAA,YAAVzD,GAAU,UAAVA,GAAU;;AAChD,YAAIyD,MAAM,KAAK,KAAX,IAAoBA,MAAM,KAAK,MAAnC,EAA2C;AACzC,iBAAO,KAAP;AACD;;AAED,YAAMxB,QAAQ,GAAGjC,GAAG,CAACiC,QAArB,CALgD,CAMhD;;AACA,YAAMK,QAAQ,GAAGL,QAAQ,CAACC,KAAT,CAAe,CAAf,CAAjB;AACA,YAAMC,OAAO,GAAGG,QAAQ,CAACJ,KAAT,CAAe,CAAf,EAAkBI,QAAQ,CAACF,OAAT,CAAiB,GAAjB,CAAlB,CAAhB;;AAEA,YAAID,OAAO,KAAK7B,8BAAhB,EAAgD;AAC9C,iBAAO,KAAP;AACD;;AAED,eAAO,IAAP;AACD,OAfW,CAAZ;AAgBD,KArDD;;AAuDA,QAAMoD,uBAAuB,GAAG,SAA1BA,uBAA0B,GAAM;AACpC,UAAMC,WAAW,GAAG,gCAApB;AACA,UAAMC,mBAAmB,GAAGD,WAA5B;AACA,aAAO,kBAAuB;AAAA,YAApB3D,GAAoB,UAApBA,GAAoB;AAAA,YAAZ6D,KAAY;;AAC5B,YAAMC,OAAO,GAAG,IAAIC,QAAJ,CAAQ/D,GAAG,CAACiC,QAAJ,CAAaC,KAAb,CAAmB,CAAnB,CAAR,oBAA0C9C,YAA1C,OAAhB;AAEA,eAAOwE,mBAAmB;AACxB5D,UAAAA,GAAG,EAAE8D;AADmB,WAErBD,KAFqB,EAA1B;AAID,OAPD;AAQD,KAXD;;AAaA,QAAMG,OAAO,GAAG,sDAAwB;AACtCC,MAAAA,QAAQ,qBACF7D,KAAK,GAAGY,mBAAmB,EAAtB,GAA2B,EAD9B,UAEN8B,0BAA0B,EAFpB,EAGNY,uBAAuB,EAHjB;AAD8B,KAAxB,CAAhB;AAQA3C,IAAAA,MAAM,CAACmD,iBAAP,CAAyBF,OAAzB,EAAkC,UAACG,QAAD;AAAA,aAAe5D,IAAI,GAAG,0CAAW4D,QAAX,CAAH,GAA0BA,QAA7C;AAAA,KAAlC;AAEA,6BACKpD,MADL;AAEEqD,MAAAA,UAAU,YAAKrD,MAAM,CAACf,GAAZ,SAAkBM,8BAAlB,CAFZ;AAGElB,MAAAA,YAAY,EAAZA,YAHF;AAIEkB,MAAAA,8BAA8B,EAA9BA,8BAJF;AAKEkD,MAAAA,WAAW,EAAEX;AALf;AAOD,GApJI,CAAP;AAqJD,CAxKM,C,CA0KP;;AACA;;;;;;;;;;;;;;;;;;;;;;AAuBA;;AACA;;;;;;;;;;;;;;;;;;;;;;AAuBA;AACA",
  "sourcesContent": [
    "// https://github.com/jsenv/core/blob/master/src/api/util/transpiler.js\n\nimport { URL } from \"url\"\nimport { createCompile } from \"../createCompile/createCompile.js\"\nimport { createCompileService } from \"../createCompileService/index.js\"\nimport { createFileService } from \"../createFileService/index.js\"\nimport { createResponseGenerator } from \"../openServer/createResponseGenerator.js\"\nimport { enableCORS } from \"../openServer/createNodeRequestHandler.js\"\nimport { openServer } from \"../openServer/openServer.js\"\nimport { createSSERoom } from \"./createSSERoom.js\"\nimport { watchFile } from \"../watchFile.js\"\nimport { createRoot } from \"@dmail/project-structure\"\n\nconst guard = (fn, shield) => (...args) => {\n  return shield(...args) ? fn(...args) : undefined\n}\n\nconst getRequiredHelper = ({ rootLocation, instrument }) => {\n  if (instrument) {\n    return createRoot({\n      root: rootLocation,\n    }).then(({ getMetaForLocation }) => {\n      const instrumentPredicate = ({ inputRelativeLocation }) => {\n        return Boolean(getMetaForLocation(inputRelativeLocation).cover)\n      }\n\n      return { instrumentPredicate }\n    })\n  }\n  return Promise.resolve({})\n}\n\nexport const openCompileServer = ({\n  // server options\n  url,\n  autoCloseOnExit,\n  autoCloseOnCrash,\n  autoCloseOnError,\n  watch = false,\n  // compile options\n  rootLocation,\n  cacheFolderRelativeLocation = \"build\",\n  abstractFolderRelativeLocation = \"compiled\",\n  cors = true,\n  transpile = true,\n  sourceMap = \"comment\", // can be \"comment\", \"inline\", \"none\"\n  sourceURL = true,\n  minify = false,\n  optimize = false,\n  instrument = false,\n}) => {\n  return Promise.all([\n    getRequiredHelper({ rootLocation, instrument }),\n    openServer({\n      url,\n      autoCloseOnExit,\n      autoCloseOnCrash,\n      autoCloseOnError,\n    }),\n  ])\n    .then(([helper, server]) => {\n      return {\n        server,\n        ...helper,\n      }\n    })\n    .then(({ server, instrumentPredicate }) => {\n      const createWatchServices = () => {\n        // https://github.com/dmail-old/http-eventsource/tree/master/lib\n\n        const fileChangedSSE = createSSERoom()\n        fileChangedSSE.open()\n        const watchedFiles = new Map()\n        server.closed.listenOnce(() => {\n          watchedFiles.forEach((closeWatcher) => closeWatcher())\n          watchedFiles.clear()\n          fileChangedSSE.close()\n        })\n        const watchPredicate = (relativeFilename) => {\n          // for now watch only js files (0 not favicon or .map files)\n          return relativeFilename.endsWith(\".js\")\n        }\n\n        return [\n          ({ headers }) => {\n            if (headers.get(\"accept\") === \"text/event-stream\") {\n              return fileChangedSSE.connect(headers.get(\"last-event-id\"))\n            }\n            return null\n          },\n          ({ url }) => {\n            let relativeFilename = url.pathname.slice(1)\n            const dirname = relativeFilename.slice(0, relativeFilename.indexOf(\"/\"))\n            if (dirname === abstractFolderRelativeLocation) {\n              // when I ask for a compiled file, watch the corresponding file on filesystem\n              relativeFilename = relativeFilename.slice(abstractFolderRelativeLocation.length + 1)\n            }\n\n            const filename = `${rootLocation}/${relativeFilename}`\n\n            if (watchedFiles.has(filename) === false && watchPredicate(relativeFilename)) {\n              const fileWatcher = watchFile(filename, () => {\n                fileChangedSSE.sendEvent({\n                  type: \"file-changed\",\n                  data: relativeFilename,\n                })\n              })\n              watchedFiles.set(url, fileWatcher)\n            }\n          },\n        ]\n      }\n\n      let compileFileFromCompileService\n      const createCompileServiceCustom = () => {\n        const compile = createCompile({\n          instrumentPredicate,\n          createOptions: () => {\n            // we should use a token or something to prevent a browser from being taken for nodejs\n            // because will have security impact as we are going to trust this\n            // const isNodeClient =\n            //   request.headers.has(\"user-agent\") &&\n            //   request.headers.get(\"user-agent\").startsWith(\"node-fetch\")\n\n            const remap = sourceMap === \"comment\" || sourceMap === \"inline\"\n            const remapMethod = sourceMap\n\n            const identify = sourceURL\n            const identifyMethod = \"relative\"\n\n            return {\n              identify,\n              identifyMethod,\n              transpile,\n              instrument,\n              remap,\n              remapMethod,\n              minify,\n              optimize,\n            }\n          },\n        })\n        const { service: compileService, compileFile } = createCompileService({\n          rootLocation,\n          cacheFolderRelativeLocation,\n          abstractFolderRelativeLocation,\n          trackHit: true,\n          compile,\n        })\n        compileFileFromCompileService = compileFile\n\n        return guard(compileService, ({ method, url }) => {\n          if (method !== \"GET\" && method !== \"HEAD\") {\n            return false\n          }\n\n          const pathname = url.pathname\n          // '/compiled/folder/file.js' -> 'compiled/folder/file.js'\n          const filename = pathname.slice(1)\n          const dirname = filename.slice(0, filename.indexOf(\"/\"))\n\n          if (dirname !== abstractFolderRelativeLocation) {\n            return false\n          }\n\n          return true\n        })\n      }\n\n      const createFileServiceCustom = () => {\n        const fileService = createFileService()\n        const previousFileService = fileService\n        return ({ url, ...props }) => {\n          const fileURL = new URL(url.pathname.slice(1), `file:///${rootLocation}/`)\n\n          return previousFileService({\n            url: fileURL,\n            ...props,\n          })\n        }\n      }\n\n      const handler = createResponseGenerator({\n        services: [\n          ...(watch ? createWatchServices() : []),\n          createCompileServiceCustom(),\n          createFileServiceCustom(),\n        ],\n      })\n\n      server.addRequestHandler(handler, (response) => (cors ? enableCORS(response) : response))\n\n      return {\n        ...server,\n        compileURL: `${server.url}${abstractFolderRelativeLocation}`,\n        rootLocation,\n        abstractFolderRelativeLocation,\n        compileFile: compileFileFromCompileService,\n      }\n    })\n}\n\n// if we want to use react we must start a compileServer like that\n/*\nimport { startCompileServer, defaultTransformer, createBabelOptions } from \"@dmail/dev-server\"\n\nstartCompileServer({\n\ttransformer: (result, options, context) => {\n\t\tconst { inputRelativeLocation } = context\n\t\tif (inputRelativeLocation.endsWith('.jsx')) {\n\t\t\tconst babelOptions = createBabelOptions(result, options, context)\n\t\t\tconst babelOptionWithReact = {\n\t\t\t\t...babelOptions,\n\t\t\t\tplugins: [\n\t\t\t\t\t['babel-plugin-syntax-jsx', {}],\n\t\t\t\t\t['babel-plugin-transform-react-jsx', { \"pragma\": \"React.createElement\" }],\n\t\t\t\t\t...babelOptions.plugins\n\t\t\t\t],\n\t\t\t}\n\t\t\treturn babel.transform(result.code, babelOptionWithReact)\n\t\t]\n\t\treturn defaultTransformer(result, options, context)\n\t}\n})\n*/\n\n// in order to support a build specific to a given browser we could\n/*\nstartCompileServer({\n\tcreateOptions: ({ request }) => {\n\t\t// we could run something client side to decide which\n\t\t// profile the client belongs to between a,b,c and send it by cookie or header\n\t\t// or decide this using user-agent\n\t\tconst profile = request.headers.get('x-client-feature-profile')\n\t\treturn {\n\t\t\tprofile\n\t\t}\n\t},\n\ttransformer: (result, options, context) => {\n\t\tif (options.profile === 'c') {\n\t\t\treturn transformFewThings(result, options, context)\n\t\t}\n\t\tif (options.profile === 'b') {\n\t\t\treturn transformSomeThings(result, options, context)\n\t\t}\n\t\treturn transformAllThings(result, options, context)\n\t}\n})\n*/\n\n// hot reloading https://github.com/dmail-old/es6-project/blob/master/lib/start.js#L62\n// and https://github.com/dmail-old/project/blob/master/lib/sse.js\n"
  ]
}