{"version":3,"sources":["../../../src/openCompileServer/openCompileServer.js"],"names":["guard","fn","shield","undefined","openCompileServer","url","autoCloseOnExit","autoCloseOnCrash","autoCloseOnError","watch","rootLocation","cacheFolderRelativeLocation","abstractFolderRelativeLocation","cors","transpile","sourceMap","sourceURL","minify","optimize","instrument","then","addRequestHandler","close","closed","createWatchServices","fileChangedSSE","open","watchedFiles","Map","listenOnce","forEach","closeWatcher","clear","watchPredicate","relativeFilename","endsWith","headers","get","connect","pathname","slice","dirname","indexOf","length","filename","has","fileWatcher","sendEvent","type","data","set","compileFileFromCompileService","createCompileServiceCustom","compile","createOptions","remap","remapMethod","identify","identifyMethod","trackHit","compileService","service","compileFile","method","createFileServiceCustom","fileService","previousFileService","props","fileURL","handler","services","response","compileURL"],"mappings":"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","file":"openCompileServer.js","sourcesContent":["// https://github.com/jsenv/core/blob/master/src/api/util/transpiler.js\n\n/* eslint-disable import/max-dependencies */\nimport { URL } from \"url\"\nimport { createCompile } from \"../createCompile/createCompile.js\"\nimport { createCompileService } from \"../createCompileService/index.js\"\nimport { createFileService } from \"../createFileService/index.js\"\nimport { createResponseGenerator } from \"../openServer/createResponseGenerator.js\"\nimport { enableCORS } from \"../openServer/createNodeRequestHandler.js\"\nimport { openServer } from \"../openServer/openServer.js\"\nimport { createSSERoom } from \"./createSSERoom.js\"\nimport { watchFile } from \"../watchFile.js\"\n\nconst guard = (fn, shield) => (...args) => {\n  return shield(...args) ? fn(...args) : undefined\n}\n\nexport const openCompileServer = ({\n  // server options\n  url,\n  autoCloseOnExit,\n  autoCloseOnCrash,\n  autoCloseOnError,\n  watch = false,\n  // compile options\n  rootLocation,\n  cacheFolderRelativeLocation = \"build\",\n  abstractFolderRelativeLocation = \"compiled\",\n  cors = true,\n  transpile = true,\n  sourceMap = \"comment\", // can be \"comment\", \"inline\", \"none\"\n  sourceURL = true,\n  minify = false,\n  optimize = false,\n  instrument = false,\n}) => {\n  return openServer({\n    url,\n    autoCloseOnExit,\n    autoCloseOnCrash,\n    autoCloseOnError,\n  }).then(({ url, addRequestHandler, close, closed }) => {\n    const createWatchServices = () => {\n      // https://github.com/dmail-old/http-eventsource/tree/master/lib\n\n      const fileChangedSSE = createSSERoom()\n      fileChangedSSE.open()\n      const watchedFiles = new Map()\n      closed.listenOnce(() => {\n        watchedFiles.forEach((closeWatcher) => closeWatcher())\n        watchedFiles.clear()\n        fileChangedSSE.close()\n      })\n      const watchPredicate = (relativeFilename) => {\n        // for now watch only js files (0 not favicon or .map files)\n        return relativeFilename.endsWith(\".js\")\n      }\n\n      return [\n        ({ headers }) => {\n          if (headers.get(\"accept\") === \"text/event-stream\") {\n            return fileChangedSSE.connect(headers.get(\"last-event-id\"))\n          }\n        },\n        ({ url }) => {\n          let relativeFilename = url.pathname.slice(1)\n          const dirname = relativeFilename.slice(0, relativeFilename.indexOf(\"/\"))\n          if (dirname === abstractFolderRelativeLocation) {\n            // when I ask for a compiled file, watch the corresponding file on filesystem\n            relativeFilename = relativeFilename.slice(abstractFolderRelativeLocation.length + 1)\n          }\n\n          const filename = `${rootLocation}/${relativeFilename}`\n\n          if (watchedFiles.has(filename) === false && watchPredicate(relativeFilename)) {\n            const fileWatcher = watchFile(filename, () => {\n              fileChangedSSE.sendEvent({\n                type: \"file-changed\",\n                data: relativeFilename,\n              })\n            })\n            watchedFiles.set(url, fileWatcher)\n          }\n        },\n      ]\n    }\n\n    let compileFileFromCompileService\n    const createCompileServiceCustom = () => {\n      const compile = createCompile({\n        createOptions: () => {\n          // we should use a token or something to prevent a browser from being taken for nodejs\n          // because will have security impact as we are going to trust this\n          // const isNodeClient =\n          //   request.headers.has(\"user-agent\") &&\n          //   request.headers.get(\"user-agent\").startsWith(\"node-fetch\")\n\n          const remap = sourceMap === \"comment\" || sourceMap === \"inline\"\n          const remapMethod = sourceMap\n\n          const identify = sourceURL\n          const identifyMethod = \"relative\"\n\n          return {\n            identify,\n            identifyMethod,\n            transpile,\n            instrument,\n            remap,\n            remapMethod,\n            minify,\n            optimize,\n          }\n        },\n      })\n      const { service: compileService, compileFile } = createCompileService({\n        rootLocation,\n        cacheFolderRelativeLocation,\n        abstractFolderRelativeLocation,\n        trackHit: true,\n        compile,\n      })\n      compileFileFromCompileService = compileFile\n\n      return guard(compileService, ({ method, url }) => {\n        if (method !== \"GET\" && method !== \"HEAD\") {\n          return false\n        }\n\n        const pathname = url.pathname\n        // '/compiled/folder/file.js' -> 'compiled/folder/file.js'\n        const filename = pathname.slice(1)\n        const dirname = filename.slice(0, filename.indexOf(\"/\"))\n\n        if (dirname !== abstractFolderRelativeLocation) {\n          return false\n        }\n\n        return true\n      })\n    }\n\n    const createFileServiceCustom = () => {\n      const fileService = createFileService()\n      const previousFileService = fileService\n      return ({ url, ...props }) => {\n        const fileURL = new URL(url.pathname.slice(1), `file:///${rootLocation}/`)\n\n        return previousFileService({\n          url: fileURL,\n          ...props,\n        })\n      }\n    }\n\n    const handler = createResponseGenerator({\n      services: [\n        ...(watch ? createWatchServices() : []),\n        createCompileServiceCustom(),\n        createFileServiceCustom(),\n      ],\n    })\n\n    addRequestHandler(handler, (response) => (cors ? enableCORS(response) : response))\n\n    return {\n      close,\n      closed,\n      url,\n      compileURL: `${url}${abstractFolderRelativeLocation}`,\n      rootLocation,\n      abstractFolderRelativeLocation,\n      compileFile: compileFileFromCompileService,\n    }\n  })\n}\n\n// if we want to use react we must start a compileServer like that\n/*\nimport { startCompileServer, defaultTransformer, createBabelOptions } from \"@dmail/dev-server\"\n\nstartCompileServer({\n\ttransformer: (result, options, context) => {\n\t\tconst { inputRelativeLocation } = context\n\t\tif (inputRelativeLocation.endsWith('.jsx')) {\n\t\t\tconst babelOptions = createBabelOptions(result, options, context)\n\t\t\tconst babelOptionWithReact = {\n\t\t\t\t...babelOptions,\n\t\t\t\tplugins: [\n\t\t\t\t\t['babel-plugin-syntax-jsx', {}],\n\t\t\t\t\t['babel-plugin-transform-react-jsx', { \"pragma\": \"React.createElement\" }],\n\t\t\t\t\t...babelOptions.plugins\n\t\t\t\t],\n\t\t\t}\n\t\t\treturn babel.transform(result.code, babelOptionWithReact)\n\t\t]\n\t\treturn defaultTransformer(result, options, context)\n\t}\n})\n*/\n\n// in order to support a build specific to a given browser we could\n/*\nstartCompileServer({\n\tcreateOptions: ({ request }) => {\n\t\t// we could run something client side to decide which\n\t\t// profile the client belongs to between a,b,c and send it by cookie or header\n\t\t// or decide this using user-agent\n\t\tconst profile = request.headers.get('x-client-feature-profile')\n\t\treturn {\n\t\t\tprofile\n\t\t}\n\t},\n\ttransformer: (result, options, context) => {\n\t\tif (options.profile === 'c') {\n\t\t\treturn transformFewThings(result, options, context)\n\t\t}\n\t\tif (options.profile === 'b') {\n\t\t\treturn transformSomeThings(result, options, context)\n\t\t}\n\t\treturn transformAllThings(result, options, context)\n\t}\n})\n*/\n\n// hot reloading https://github.com/dmail-old/es6-project/blob/master/lib/start.js#L62\n// and https://github.com/dmail-old/project/blob/master/lib/sse.js\n"]}