{
  "version": 3,
  "sources": [
    "../../../src/openNodeClient/openNodeClient.js"
  ],
  "names": [
    "openNodeClient",
    "compileURL",
    "remoteRoot",
    "localRoot",
    "detached",
    "execute",
    "file",
    "collectCoverage",
    "executeTest",
    "close",
    "promise",
    "Promise",
    "resolve",
    "then",
    "remoteFile",
    "setup",
    "teardown",
    "import",
    "clientFile",
    "path",
    "__dirname",
    "previousID",
    "autoClose",
    "autoCloseOnError",
    "closed",
    "emit",
    "reject",
    "id",
    "child",
    "execArgv",
    "kill",
    "listen",
    "on",
    "code",
    "remove",
    "Error",
    "onmessage",
    "message",
    "type",
    "data",
    "removeListener",
    "value",
    "console",
    "log",
    "send",
    "setupSource",
    "toString",
    "teardownSource",
    "reason"
  ],
  "mappings": "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",
  "sourcesContent": [
    "// faut vraiment que je teste ça avec https://github.com/GoogleChromeLabs/ndb\n// en gros voir si ndb va fonctionner\n// pour debug l'éxécution de nodejs avec chrome devtools\n// en utilisant system.import\n\nimport { fork } from \"child_process\"\nimport path from \"path\"\nimport { ensureSystem } from \"./ensureSystem.js\"\nimport \"./global-fetch.js\"\nimport { getRemoteLocation } from \"../getRemoteLocation.js\"\nimport { getNodeSetupAndTeardowm } from \"../getClientSetupAndTeardown.js\"\nimport { createSignal } from \"@dmail/signal\"\n\nexport const openNodeClient = ({ compileURL, remoteRoot, localRoot, detached = false }) => {\n  if (detached === false) {\n    const execute = ({ file, collectCoverage = false, executeTest = false }) => {\n      const close = () => {}\n\n      const promise = Promise.resolve().then(() => {\n        const remoteFile = getRemoteLocation({\n          compileURL,\n          file,\n        })\n\n        const { setup, teardown } = getNodeSetupAndTeardowm({ collectCoverage, executeTest })\n\n        Promise.resolve(remoteFile)\n          .then(setup)\n          .then(() => {\n            return ensureSystem({ remoteRoot, localRoot })\n              .import(remoteFile)\n              .then(teardown)\n          })\n      })\n\n      return Promise.resolve({ promise, close })\n    }\n\n    return Promise.resolve({ execute })\n  }\n\n  const clientFile = path.resolve(__dirname, \"./client.js\")\n  let previousID = 0\n\n  const execute = ({\n    file,\n    autoClose = false,\n    autoCloseOnError = false,\n    executeTest = false,\n    collectCoverage = false,\n  }) => {\n    const closed = createSignal()\n\n    const close = () => {\n      closed.emit()\n    }\n\n    const promise = new Promise((resolve, reject) => {\n      const id = previousID + 1\n      previousID = id\n\n      const child = fork(clientFile, {\n        execArgv: [\n          // allow vscode to debug else you got port already used\n          `--inspect-brk`,\n        ],\n      })\n\n      const kill = closed.listen(() => {\n        child.kill()\n      })\n\n      child.on(\"close\", (code) => {\n        kill.remove()\n\n        if (code === 12) {\n          throw new Error(\n            `child exited with 12: forked child wanted to use a non available port for debug`,\n          )\n        }\n        if (code !== 0) {\n          reject(`exited with code ${code}`)\n        }\n      })\n\n      const onmessage = (message) => {\n        if (message.id !== id) {\n          return\n        }\n\n        const { type, data } = message\n        if (type === \"execute-result\") {\n          child.removeListener(\"message\", onmessage)\n          if (data.code === 0) {\n            resolve(data.value)\n          } else {\n            console.log(\"rejecting\")\n            reject(data.value)\n          }\n        }\n      }\n\n      child.on(\"message\", onmessage)\n\n      const remoteFile = getRemoteLocation({\n        compileURL,\n        file,\n      })\n      const { setup, teardown } = getNodeSetupAndTeardowm({ collectCoverage, executeTest })\n\n      child.send({\n        type: \"execute\",\n        id,\n        data: {\n          remoteRoot,\n          localRoot,\n          file: remoteFile,\n          setupSource: `(${setup.toString()})`,\n          teardownSource: `(${teardown.toString()})`,\n        },\n      })\n    }).then(\n      (value) => {\n        if (autoClose) {\n          close()\n        }\n        return value\n      },\n      (reason) => {\n        if (autoCloseOnError) {\n          close()\n        }\n        return Promise.reject(reason)\n      },\n    )\n\n    return Promise.resolve({ promise, close })\n  }\n\n  return Promise.resolve({ execute })\n}\n"
  ]
}