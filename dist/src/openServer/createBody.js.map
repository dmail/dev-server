{
  "version": 3,
  "sources": [
    "../../../src/openServer/createBody.js"
  ],
  "names": [
    "isNodeStream",
    "a",
    "undefined",
    "stream",
    "Stream",
    "Writable",
    "closeStream",
    "end",
    "close",
    "createTwoWayStream",
    "willAutoClose",
    "buffers",
    "length",
    "status",
    "promise",
    "resolve",
    "errored",
    "smart",
    "cancelled",
    "closed",
    "writed",
    "error",
    "e",
    "emit",
    "cancel",
    "write",
    "data",
    "push",
    "pipeTo",
    "propagateData",
    "propagateCancel",
    "propagateClose",
    "propagateError",
    "listenOnce",
    "forEach",
    "buffer",
    "writeListener",
    "listen",
    "Object",
    "freeze",
    "stringToArrayBuffer",
    "string",
    "String",
    "ArrayBuffer",
    "bufferView",
    "Uint16Array",
    "i",
    "charCodeAt",
    "createBody",
    "twoWayStream",
    "nodeStream",
    "once",
    "on",
    "readAsString",
    "then",
    "join",
    "text",
    "arraybuffer",
    "json",
    "JSON",
    "parse"
  ],
  "mappings": "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",
  "sourcesContent": [
    "import stream from \"stream\"\nimport { createPromiseAndHooks } from \"../promise.js\"\nimport { createSignal } from \"@dmail/signal\"\n\nconst isNodeStream = (a) => {\n  if (a === undefined) return false\n  if (a instanceof stream.Stream || a instanceof stream.Writable) {\n    return true\n  }\n  return false\n}\n\nconst closeStream = (stream) => {\n  if (isNodeStream(stream)) {\n    stream.end()\n  } else {\n    stream.close()\n  }\n}\n\nconst createTwoWayStream = ({ willAutoClose = false } = {}) => {\n  const buffers = []\n  let length = 0\n  let status = \"opened\"\n\n  const { promise, resolve } = createPromiseAndHooks()\n\n  const errored = createSignal({ smart: true })\n  const cancelled = createSignal({ smart: true })\n  const closed = createSignal({ smart: true })\n  const writed = createSignal()\n\n  const error = (e) => {\n    status = \"errored\"\n    errored.emit(e)\n    throw e\n  }\n\n  const cancel = () => {\n    if (status === \"cancelled\") {\n      return\n    }\n    status = \"cancelled\"\n    buffers.length = 0\n    length = 0\n    cancelled.emit()\n  }\n\n  const close = () => {\n    if (status === \"closed\") {\n      return\n    }\n    status = \"closed\"\n    resolve(buffers)\n    closed.emit()\n  }\n\n  const write = (data) => {\n    // if (status === \"closed\") {\n    //   return\n    // }\n    // console.log(\"writing\", data.toString())\n    buffers.push(data)\n    length += data.length\n    writed.emit(data)\n  }\n\n  const pipeTo = (\n    stream,\n    {\n      propagateData = true,\n      propagateCancel = true,\n      propagateClose = true,\n      propagateError = true,\n    } = {},\n  ) => {\n    if (propagateCancel) {\n      cancelled.listenOnce(() => {\n        stream.cancel()\n      })\n    }\n    if (propagateError) {\n      errored.listenOnce((error) => {\n        stream.error(error)\n      })\n    }\n    if (propagateData) {\n      if (length) {\n        buffers.forEach((buffer) => {\n          stream.write(buffer)\n        })\n      }\n      const writeListener = writed.listen((buffer) => {\n        stream.write(buffer)\n      })\n      // closed.listenOnce(() => {\n      //   writeListener.remove()\n      // })\n    }\n    if (propagateClose) {\n      closed.listenOnce(() => {\n        closeStream(stream)\n      })\n    }\n\n    return stream\n  }\n\n  return Object.freeze({\n    error,\n    errored,\n    cancel,\n    cancelled,\n    close,\n    closed,\n    write,\n    writed,\n    pipeTo,\n    promise,\n    willAutoClose,\n  })\n}\n\nconst stringToArrayBuffer = (string) => {\n  string = String(string)\n  const buffer = new ArrayBuffer(string.length * 2) // 2 bytes for each char\n  const bufferView = new Uint16Array(buffer)\n  let i = 0\n  while (i < string.length) {\n    bufferView[i] = string.charCodeAt(i)\n    i++\n  }\n  return buffer\n}\n\nexport const createBody = (data) => {\n  if (data && data.pipeTo) {\n    return data\n  }\n\n  let twoWayStream\n\n  if (data === undefined) {\n    twoWayStream = createTwoWayStream()\n  } else if (isNodeStream(data)) {\n    twoWayStream = createTwoWayStream({ willAutoClose: true })\n\n    const nodeStream = data\n\n    // nodeStream.resume() ?\n    nodeStream.once(\"error\", (error) => {\n      twoWayStream.error(error)\n    })\n    nodeStream.on(\"data\", (data) => {\n      twoWayStream.write(data)\n    })\n    nodeStream.once(\"end\", () => {\n      twoWayStream.close()\n    })\n  } else if (data && data.pipeTo) {\n    twoWayStream = createTwoWayStream({ willAutoClose: data.willAutoClose })\n    data.pipeTo(twoWayStream)\n  } else if (data !== undefined) {\n    twoWayStream = createTwoWayStream()\n    twoWayStream.write(data)\n  }\n\n  const readAsString = () => {\n    return twoWayStream.promise.then((buffers) => buffers.join(\"\"))\n  }\n\n  const text = () => {\n    return readAsString()\n  }\n\n  const arraybuffer = () => {\n    return text().then(stringToArrayBuffer)\n  }\n\n  const json = () => {\n    return text().then(JSON.parse)\n  }\n\n  return {\n    ...twoWayStream,\n    text,\n    arraybuffer,\n    json,\n  }\n}\n"
  ]
}