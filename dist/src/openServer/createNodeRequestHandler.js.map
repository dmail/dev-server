{
  "version": 3,
  "sources": [
    "../../../src/openServer/createNodeRequestHandler.js"
  ],
  "names": [
    "createRequestFromNodeRequest",
    "nodeRequest",
    "serverURL",
    "method",
    "url",
    "URL",
    "headers",
    "body",
    "undefined",
    "Object",
    "freeze",
    "populateNodeResponse",
    "nodeResponse",
    "status",
    "reason",
    "headerAsJSON",
    "toJSON",
    "writeHead",
    "pipeTo",
    "get",
    "close",
    "createResponse",
    "createNodeRequestHandler",
    "handler",
    "transform",
    "response",
    "closed",
    "smart",
    "once",
    "emit",
    "request",
    "console",
    "log",
    "toString",
    "on",
    "error",
    "Promise",
    "resolve",
    "then",
    "responseProperties",
    "catch",
    "stack",
    "finalResponse",
    "listen",
    "enableCORS",
    "corsHeaders",
    "join",
    "headersWithCORS",
    "keys",
    "forEach",
    "corsHeaderName",
    "has",
    "append"
  ],
  "mappings": "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",
  "sourcesContent": [
    "// https://github.com/jsenv/core/tree/master/src/util/rest\n\nimport { URL } from \"url\"\nimport { createBody } from \"./createBody.js\"\nimport { createHeaders } from \"./createHeaders.js\"\nimport { createSignal } from \"@dmail/signal\"\n\n// serverURL pourrait valoir par dÃ©faut `file:///${process.cwd()}` ?\nexport const createRequestFromNodeRequest = (nodeRequest, serverURL) => {\n  const { method } = nodeRequest\n  const url = new URL(nodeRequest.url, serverURL)\n  const headers = createHeaders(nodeRequest.headers)\n  const body = createBody(\n    method === \"POST\" || method === \"PUT\" || method === \"PATCH\" ? nodeRequest : undefined,\n  )\n\n  return Object.freeze({\n    method,\n    url,\n    headers,\n    body,\n  })\n}\n\nexport const populateNodeResponse = (nodeResponse, { status, reason = \"\", headers, body }) => {\n  const headerAsJSON = headers.toJSON()\n  nodeResponse.writeHead(status, reason, headerAsJSON)\n\n  body.pipeTo(nodeResponse)\n  if (headers.get(\"connection\") !== \"keep-alive\") {\n    body.close()\n  }\n}\n\nconst createResponse = (\n  { method },\n  { status = 501, reason, headers = createHeaders(), body = createBody() } = {},\n) => {\n  if (method === \"HEAD\") {\n    // don't send body for HEAD requests\n    body = createBody()\n  } else {\n    body = createBody(body)\n  }\n\n  headers = createHeaders(headers)\n\n  return Object.freeze({ status, reason, headers, body })\n}\n\nexport const createNodeRequestHandler = ({ handler, transform = (response) => response, url }) => {\n  return (nodeRequest, nodeResponse) => {\n    const closed = createSignal({ smart: true })\n    nodeResponse.once(\"close\", () => closed.emit())\n\n    // should have some kind of id for a request\n    // so that logs knows whichs request they belong to\n    const request = createRequestFromNodeRequest(nodeRequest, url)\n    console.log(request.method, request.url.toString())\n\n    nodeRequest.on(\"error\", (error) => {\n      console.log(\"error on\", request.url.toString(), error)\n    })\n\n    return Promise.resolve()\n      .then(() => {\n        return handler(request)\n      })\n      .then((responseProperties) => {\n        const response = createResponse(request, responseProperties)\n        return transform(response)\n      })\n      .catch((error) => {\n        return createResponse(request, {\n          status: 500,\n          reason: \"internal error\",\n          body: error && error.stack ? error.stack : error,\n        })\n      })\n      .then((finalResponse) => {\n        console.log(`${finalResponse.status} ${request.url}`)\n        // ensure body is closed when client is closed\n        closed.listen(() => {\n          finalResponse.body.close()\n        })\n        populateNodeResponse(nodeResponse, finalResponse)\n      })\n  }\n}\n\nexport const enableCORS = (response) => {\n  const corsHeaders = {\n    \"access-control-allow-origin\": \"*\",\n    \"access-control-allow-methods\": [\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"].join(\", \"),\n    \"access-control-allow-headers\": [\"x-requested-with\", \"content-type\", \"accept\"].join(\", \"),\n    \"access-control-max-age\": 1, // Seconds\n  }\n\n  const headersWithCORS = createHeaders(response.headers)\n  Object.keys(corsHeaders).forEach((corsHeaderName) => {\n    if (response.headers.has(corsHeaderName) === false) {\n      // we should merge any existing response cors headers with the one above\n      headersWithCORS.append(corsHeaderName, corsHeaders[corsHeaderName])\n    }\n  })\n\n  return {\n    ...response,\n    headers: headersWithCORS,\n  }\n}\n"
  ]
}