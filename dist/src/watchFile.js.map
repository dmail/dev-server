{
  "version": 3,
  "sources": [
    "../../src/watchFile.js"
  ],
  "names": [
    "getModificationDate",
    "url",
    "Promise",
    "resolve",
    "reject",
    "fs",
    "stat",
    "error",
    "mtime",
    "guardAsync",
    "fn",
    "shield",
    "args",
    "then",
    "shielded",
    "undefined",
    "createChangedAsyncShield",
    "value",
    "get",
    "compare",
    "lastValue",
    "all",
    "previousValue",
    "limitRate",
    "ms",
    "canBeCalled",
    "setTimeout",
    "createWatchSignal",
    "installer",
    "emit",
    "modificationDate",
    "nextModificationDate",
    "Number",
    "guardedEmit",
    "watcher",
    "watch",
    "persistent",
    "eventType",
    "filename",
    "close",
    "memoizedCreateWatchSignal",
    "watchFile",
    "listen"
  ],
  "mappings": "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",
  "sourcesContent": [
    "import { createSignal } from \"@dmail/signal\"\nimport fs from \"fs\"\nimport { memoizeSync } from \"./memoize.js\"\n\nconst getModificationDate = (url) => {\n  return new Promise((resolve, reject) => {\n    fs.stat(url, (error, stat) => {\n      if (error) {\n        reject(error)\n      } else {\n        resolve(stat.mtime)\n      }\n    })\n  })\n}\n\nconst guardAsync = (fn, shield) => (...args) => {\n  return Promise.resolve()\n    .then(() => shield(...args))\n    .then((shielded) => {\n      return shielded ? undefined : fn(...args)\n    })\n}\n\nconst createChangedAsyncShield = ({ value, get, compare }) => {\n  let lastValue\n\n  return (...args) => {\n    return Promise.all([\n      lastValue === undefined ? value : lastValue,\n      Promise.resolve().then(() => get(...args)),\n    ]).then(([previousValue, value]) => {\n      lastValue = value\n      return !compare(previousValue, value)\n    })\n  }\n}\n\nconst limitRate = (fn, ms) => {\n  let canBeCalled = true\n  return (...args) => {\n    if (!canBeCalled) {\n      return undefined\n    }\n\n    canBeCalled = false\n    setTimeout(() => {\n      canBeCalled = true\n    }, ms)\n    return fn(...args)\n  }\n}\n\nconst createWatchSignal = (url) => {\n  // get mtime right now\n  const mtime = getModificationDate(url)\n\n  return createSignal({\n    installer: ({ emit }) => {\n      const shield = createChangedAsyncShield({\n        value: mtime,\n        get: () => getModificationDate(url),\n        compare: (modificationDate, nextModificationDate) => {\n          return Number(modificationDate) !== Number(nextModificationDate)\n        },\n      })\n\n      const guardedEmit = guardAsync(emit, shield)\n      // https://nodejs.org/docs/latest/api/fs.html#fs_fs_watch_filename_options_listener\n      const watcher = fs.watch(\n        url,\n        { persistent: false },\n        limitRate((eventType, filename) => {\n          guardedEmit({ url, eventType, filename })\n        }, 100),\n      )\n      return () => watcher.close()\n    },\n  })\n}\n\nconst memoizedCreateWatchSignal = memoizeSync(createWatchSignal)\n\nexport const watchFile = (url, fn) => {\n  return memoizedCreateWatchSignal(url).listen(fn)\n}\n"
  ]
}