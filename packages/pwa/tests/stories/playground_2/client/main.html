<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8" />
    <link rel="icon" href="data:," />
  </head>

  <body>
    <div id="animal_ui">
      <fieldset>
        <legend>Animal image <button id="refresh">refresh</button></legend>
        <img style="display: block" height="200" src="./animal.svg?v=dog" />
      </fieldset>
    </div>
    <div id="service_worker_ui">
      <fieldset>
        <legend>Service worker script</legend>
        <div>
          <button id="resolve_install" disabled>Resolve install promise</button>
          <button id="reject_install" disabled>Reject install promise</button>
        </div>
        <div>
          <button id="resolve_activate" disabled>
            Resolve activate promise
          </button>
          <button id="reject_activate" disabled>Reject activate promise</button>
        </div>

        <button id="register" disabled>register sw.js</button>
        <button id="unregister" disabled>unregister</button>
        <br />
        <br />
        <button id="update_check_button" disabled>Check for updates</button>
        <div id="update_downloading_message" style="display: none">
          Downloading update...
        </div>
        <button id="update_by_restart_button" disabled>
          Restart to update
        </button>
        <button id="update_now_button" disabled>Apply update</button>

        <br />
        <br />
        Navigator controller: <span id="controller"></span>
      </fieldset>
    </div>
    <div id="trigger_file_changes">
      <fieldset>
        <legend>Update files</legend>
        <button id="build_dog">Build dog</button>
        <button id="build_horse">Build horse</button>
        <button id="build_cat">Build cat</button>
        <button id="build_sw_script">Build sw script</button>
      </fieldset>
    </div>

    <script type="module">
      import {
        pwaLogger,
        navigatorController,
        createServiceWorkerScript,
      } from "@jsenv/pwa"

      pwaLogger.setOptions({
        logLevel: "debug",
      })

      const img = document.querySelector("img")
      const refreshImg = async () => {
        img.src = ""
        const response = await window.fetch("./animal.svg?v=dog")
        const blob = await response.blob()
        const objectUrl = URL.createObjectURL(blob)
        await new Promise((resolve) => setTimeout(resolve, 150))
        img.src = objectUrl
      }

      const refreshButton = document.querySelector("#refresh")
      refreshButton.onclick = async () => {
        refreshButton.disabled = true
        try {
          await refreshImg()
        } finally {
          refreshButton.disabled = false
        }
      }

      const controllerSpan = document.querySelector("#controller")
      navigatorController.subscribe((controller) => {
        if (controller) {
          controllerSpan.innerHTML = `${controller.meta.version}`
        } else {
          controllerSpan.innerHTML = "no"
        }
      })

      const topLevelSwScript = createServiceWorkerScript({
        hotUpdateHandlers: {
          "animal.svg": {
            replace: refreshImg,
            prune: () => URL.revokeObjectURL(img.src),
          },
        },
      })
      const registerButton = document.querySelector("#register")
      registerButton.disabled = false

      const updateDownloadingMessage = document.querySelector(
        "#update_downloading_message",
      )
      topLevelSwScript.subscribe(({ update }) => {
        if (update.readyState === "installing") {
          updateDownloadingMessage.style.display = "block"
          updateDownloadingMessage.innerHTML = `Downloading update ${update.meta.version} ...`
        } else {
          updateDownloadingMessage.style.display = "none"
        }
      })

      // install instrumentation
      {
        const installResolveButton = document.querySelector("#resolve_install")
        installResolveButton.onclick = () => {
          topLevelSwScript.postMessage({ action: "resolve_install" })
        }
        const installRejectButton = document.querySelector("#reject_install")
        installRejectButton.onclick = () => {
          topLevelSwScript.postMessage({ action: "reject_install" })
        }
        topLevelSwScript.subscribe(({ meta }) => {
          const { installInstrumentation } = meta
          installResolveButton.disabled = !installInstrumentation
          installRejectButton.disabled = !installInstrumentation
        })
      }

      // activate instrumentation
      {
        const activateResolveButton =
          document.querySelector("#resolve_activate")
        activateResolveButton.onclick = () => {
          topLevelSwScript.postMessage({ action: "resolve_activate" })
        }
        const activateRejectButton = document.querySelector("#reject_activate")
        activateRejectButton.onclick = () => {
          topLevelSwScript.postMessage({ action: "reject_activate" })
        }
        topLevelSwScript.subscribe(({ meta }) => {
          const { activateInstrumentation } = meta
          activateResolveButton.disabled = !activateInstrumentation
          activateRejectButton.disabled = !activateInstrumentation
        })
      }

      registerButton.onclick = async () => {
        registerButton.disabled = true
        try {
          const registrationPromise =
            window.navigator.serviceWorker.register("./sw.js")
          topLevelSwScript.setRegistationPromise(registrationPromise)
          await registrationPromise
        } finally {
          registerButton.disabled = false
        }
      }
      // in practice there will be no such UI, it's only for dev 99% of the time
      const unregisterButton = document.querySelector("#unregister")
      unregisterButton.disabled = false
      unregisterButton.onclick = async () => {
        unregisterButton.disabled = true
        try {
          await topLevelSwScript.unregister()
        } finally {
          unregisterButton.disabled = false
        }
      }

      const buildDogButton = document.querySelector("#build_dog")
      buildDogButton.onclick = () => {
        fetch("/update_animal_to_dog")
      }
      const buildHorseButton = document.querySelector("#build_horse")
      buildHorseButton.onclick = () => {
        fetch("/update_animal_to_horse")
      }
      const buildCatButton = document.querySelector("#build_cat")
      buildCatButton.onclick = () => {
        fetch("/update_animal_to_cat")
      }

      const updateCheckButton = document.querySelector("#update_check_button")
      updateCheckButton.disabled = false
      updateCheckButton.onclick = async () => {
        updateCheckButton.disabled = true
        try {
          const update = await topLevelSwScript.checkForUpdates()
          if (!update) {
            // eslint-disable-next-line no-alert
            window.alert("there is no update available")
          }
        } finally {
          updateCheckButton.disabled = false
        }
      }

      const updateByRestartButton = document.querySelector(
        "#update_by_restart_button",
      )
      updateByRestartButton.onclick = async () => {
        updateByRestartButton.disabled = true
        // idéalement update le message du boutton pendant qu'il est
        // désactivé pour dire ce qu'il se passe (activating, ...)
        await topLevelSwScript.activateUpdate()
      }
      const updateNowButton = document.querySelector("#update_now_button")
      updateNowButton.onclick = async () => {
        updateNowButton.disabled = true
        // idéalement update le message du bouton pendant que apply se produit
        await topLevelSwScript.activateUpdate()
      }
      topLevelSwScript.subscribe(({ update }) => {
        if (update.readyState === "installed") {
          updateByRestartButton.innerHTML = `Restart to update to ${update.meta.version}`
          updateByRestartButton.disabled = update.reloadRequired
          updateNowButton.innerHTML = `Apply update ${update.meta.version}`
          updateNowButton.disabled = !update.reloadRequired
        } else {
          updateByRestartButton.disabled = true
          updateNowButton.disabled = true
        }
      })
    </script>
  </body>
</html>
