<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8" />
    <link rel="icon" href="data:," />
    <link rel="stylesheet" type="text/css" href="./style.css" />
  </head>

  <body>
    <script>
      window.namespacePromise = new Promise((resolve) => {
        window.resolveNamespacePromise = resolve
      })
    </script>
    <script type="module">
      const namespace = {}

      const testWorker = async (worker) => {
        const pingResponse = await new Promise((resolve, reject) => {
          worker.onmessage = (e) => {
            resolve(e.data)
          }
          worker.onerror = (e) => {
            reject(e.message)
          }
          worker.postMessage("ping")
        })
        return pingResponse
      }

      const workerUrl = new URL("./worker/worker.js", import.meta.url)
      const worker = new Worker(workerUrl, { type: "module" })
      namespace.worker = {
        url: String(workerUrl),
        pingResponse: await testWorker(worker),
      }

      // const registerServiceWorker = async (url, options) => {
      //   const serviceWorker = await window.navigator.serviceWorker
      //     .register(url, options)
      //     .then((registration) => {
      //       const { installing, waiting, active } = registration
      //       return installing || waiting || active
      //     })
      //   return serviceWorker
      // }
      // const testServiceWorker = async (serviceWorker) => {
      //   const inspectResponse = await new Promise((resolve) => {
      //     const { port1, port2 } = new MessageChannel()
      //     port1.onmessage = function (event) {
      //       resolve(event.data)
      //     }
      //     serviceWorker.postMessage("inspect", [port2])
      //   })
      //   return inspectResponse
      // }
      // const serviceWorkerUrl = new URL(
      //   "./service_worker/sw.js",
      //   import.meta.url,
      // )
      // const serviceWorker = await registerServiceWorker(serviceWorkerUrl, {
      //   type: "module",
      // })
      // namespace.serviceWorker = {
      //   url: String(serviceWorkerUrl),
      //   inspectResponse: await testServiceWorker(serviceWorker),
      // }

      const classicWorkerUrl = new URL(
        "/test/workers/classic_worker/worker.js",
        import.meta.url,
      )
      const classicWorker = new Worker(classicWorkerUrl)
      namespace.classicWorker = {
        url: String(classicWorkerUrl),
        pingResponse: await testWorker(classicWorker),
      }
      // const classicServiceWorkerUrl = new URL(
      //   "/test/workers/classic_service_worker/sw.js",
      //   import.meta.url,
      // )
      // const classicServiceWorker = await registerServiceWorker(
      //   classicServiceWorkerUrl,
      // )
      // namespace.classicServiceWorker = {
      //   url: String(classicServiceWorkerUrl),
      //   inspectResponse: await testServiceWorker(classicServiceWorker),
      // }

      window.resolveNamespacePromise(namespace)

      export { namespace }
    </script>
  </body>
</html>
